<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>A secret to Event Processing</title>
    <link href="/2022/05/19/secret-to-event-processing/"/>
    <url>/2022/05/19/secret-to-event-processing/</url>
    
    <content type="html"><![CDATA[<p>At Cherry, we process hundreds of events per second. For Cherry users, we capture and process data every time their customers visit a web page, take an action, purchase an item, etc. Processing events is a mission critical function to understand customer behaviour in real time. So when we discovered that processing latency for some Cherry users was several days, finding and solving the issue became our #1 priority.</p><p>I wrote this to help anyone in a similar position and share what we learned.</p><p><img src="/images/secret-to-event-processing/delayed_event.png" alt="Data showing large delay between timestamp and created time"></p><p>A typical event payload, with latency timestamps emphasised</p><h2 id="The-investigation"><a href="#The-investigation" class="headerlink" title="The investigation"></a>The investigation</h2><p>Why was it taking several days for some events to show up in Cherry? When Cherry events are ingested they are placed into an Azure Event Hub for processing by a (theoretically) scalable backend running on Azure Functions. This process should be near real time. But (as seen in the event data above) the difference between the event timestamp (i.e. ingestion time) and created time (i.e. process time) was growing rapidly and was at ~6 days.</p><p>Our first instinct was to increase the total number of workers processing events. Things are slow — throw more compute at it! However, this didn’t actually improve the latency or even the total number of events being processed per second.</p><p><img src="/images/secret-to-event-processing/events_per_hour.png" alt="Plotting the event processing throughput using KQL"></p><p>Plotting the event processing throughput using KQL</p><h2 id="The-complication"><a href="#The-complication" class="headerlink" title="The complication"></a>The complication</h2><p>Increasing the number of workers (i.e. increasing compute) didn’t really solve the issue. If the choke point was the number of workers, then we’d expect the # of events processed to increase proportionally — but it didn’t increase above it’s prior maximum. This implied that the choke point existed outside the event processor, either at the input or the output.</p><p>Since the input to the event processor was an Azure Event Hub that was running at well below its theoretical maximum throughput, we naturally turned to the database to which events were being written. Inspecting the query performance, we discovered one query was taking a very long time, typically 80 seconds! This one query was taking so long, that the mean time to process a single event had blown out to 85 seconds.</p><p><img src="/images/secret-to-event-processing/event_processing_time_before.png" alt="Plotting the max and mean event processing time using KQL"><br>Plotting the max and mean event processing time using KQL</p><h2 id="The-discovery"><a href="#The-discovery" class="headerlink" title="The discovery"></a>The discovery</h2><p>Why was this query taking so long? Turns out, it was “find-and-replace” logic, written by yours truely, for the brilliantly useless functionality that replaced an event if its ID already existed in the database. There is a reason why event logs are generally append-only! As the number of events in the database had grown, the performance of this previously innocuous query had steadily degraded. At first, the latency was only a few seconds, then a few minutes, but soon it became hours and days. Since the situation wasn’t really an “error” in the conventional sense, they weren’t picked up by our automated monitoring systems. Nonetheless, with this knowledge in hand, we were ready to take action.</p><p><img src="/images/secret-to-event-processing/event_processing_time_fixed.png" alt="Results of the fix — a dramatic improvement"></p><p>Results of the fix — a dramatic improvement</p><h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><p>Going back to first principals, we realised that an event log shouldn’t be responsible for updating events that already exist. It doesn’t scale and it’s uncommon behaviour. When we decided to remove the offending query from the event processor, the processing time dropped dramatically, from 80 seconds to fractions of a second. We let the a database index deal with clashing IDs, and pass any errors into a dead letter queue. The lesson here is twofold</p><p>Keep your event processors FAST. Slow event processing can slowly backup your entire pipeline and cause serious congestion.<br>Event logs should be append only. Updates (which happen rarely if at all) should be handled by a separate process.<br>Learn more<br>Cherry is a SaaS tool for improving ROI from promotion campaigns. Learn more at our website.</p>]]></content>
    
    
    
    <tags>
      
      <tag>web, azure, event processing, cherry</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Bots in Kubernetes</title>
    <link href="/2018/08/02/bots-in-kubernetes/"/>
    <url>/2018/08/02/bots-in-kubernetes/</url>
    
    <content type="html"><![CDATA[<h1 id="Bots-in-Kube"><a href="#Bots-in-Kube" class="headerlink" title="Bots in Kube"></a>Bots in Kube</h1><p>So you’ve built for first bot with Microsoft <a href="https://docs.microsoft.com/en-us/azure/bot-service/nodejs/bot-builder-nodejs-quickstart?view=azure-bot-service-3.0">BotBuilder SDK</a>, deployed it to <a href="https://azure.microsoft.com/en-au/services/app-service/">Azure App Service</a> or <a href="https://cloud.google.com/appengine/">GCloud App Engine</a>, and everything is just swell. Then along comes your company’s CTO, who says they’ve committed to all their services having zero downtime (best effort of course). On the same day, your friend had the great idea to start doing A/B testing. What do you do?</p><p>You’ve outgrown the App Service platform. Hello Kubernetes.</p><h2 id="What-to-do"><a href="#What-to-do" class="headerlink" title="What to do"></a>What to do</h2><p>There’s three things we have to do to get our bot into k8s.</p><ol><li>Containerise the bot code</li><li>Provision a Kubernetes Cluster</li><li>Enable cluster HTTPS Ingress</li></ol><h2 id="Containerising-a-Bot"><a href="#Containerising-a-Bot" class="headerlink" title="Containerising a Bot"></a>Containerising a Bot</h2><p>Lucky for us, bots look mostly like web servers, and we’re pretty good at containerising web servers. Create a <code>Dockerfile</code> that builds your bot image. It should look something like this one, which uses the <a href="https://docs.docker.com/develop/develop-images/multistage-build/">builder pattern</a> to reduce the size of the output image.</p><figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs docker"><span class="hljs-comment"># this file builds a bot built in Typescript.</span><br><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">16.04</span> as builder<br><span class="hljs-keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span><br><span class="language-bash">    apt-get install -y curl &amp;&amp; \</span><br><span class="language-bash">    curl -sL https://deb.nodesource.com/setup_10.x | bash &amp;&amp; \</span><br><span class="language-bash">    apt-get install -y git nodejs build-essential</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> npm install -g node-gyp &amp;&amp; \</span><br><span class="language-bash">    npm install -g typescript</span><br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /build</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> my-bot/package.json .</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> npm install <span class="hljs-comment"># this helps reduce build times during dev iteration</span></span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> my-bot .</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> npm run build</span><br><br><br><span class="hljs-keyword">FROM</span> node:<span class="hljs-number">10</span>-alpine<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app/</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /build .</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [ <span class="hljs-string">&quot;node&quot;</span>, <span class="hljs-string">&quot;js/app.js&quot;</span> ]</span><br></code></pre></td></tr></table></figure><p>Running the container locally and connecting with the <a href="https://github.com/Microsoft/BotFramework-Emulator">Bot Framework Emulator</a>, you might see this error </p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs txt">BotFrameworkAdapter.processActivity(): 500 ERROR - FetchError: request to http://localhost:60321/v3/conversations/1dk6m0la5ji6/activities/bcmfna2mfjmf failed, reason: connect ECONNREFUSED 127.0.0.1:60321<br></code></pre></td></tr></table></figure><p>That’s because the Emulator opens a localhost port to listen for messages from the bot, but that address is not actually accessible from inside the container, hence the connection refused. You need to disable ‘Bypass ngrok for local addresses’.</p><p><img src="/images/botsinkube/bypass-ngrok.png" alt="Screenshot of bypass ngrok on localhost setting disabled"></p><h3 id="Publish-the-image"><a href="#Publish-the-image" class="headerlink" title="Publish the image"></a>Publish the image</h3><p>Once you’ve built the image, publish it to the repository of your choice, e.g. <a href="https://hub.docker.com/">Docker Hub</a>. Now it’s ready to be deployed into the cluster.</p><h2 id="Provision-a-Kubernetes-Cluster"><a href="#Provision-a-Kubernetes-Cluster" class="headerlink" title="Provision a Kubernetes Cluster"></a>Provision a Kubernetes Cluster</h2><p>Now creating a kubernetes cluster from scratch is hard. If your like me, you’d prefer if someone else did the hard work for you. Well they have!</p><p><a href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough">Azure Kubernetes Service (AKS)</a> is the fasted way to get a cluster up and running. Just spin it up via Azure CLI. Then run this command - <code>az aks get-credentials</code> - and kubectl now interacts with the cluster. Almost too easy.</p><blockquote><p>Side note: It’s important to have a stateless bot (i.e. state remains in a remote database like CosmosDB and not memory) because Kubernetes deployments work best this way.</p></blockquote><h3 id="Deploy-the-bot"><a href="#Deploy-the-bot" class="headerlink" title="Deploy the bot"></a>Deploy the bot</h3><p>Your bot will need three kubernetes objects: a <code>deployment</code>, a <code>service</code>, and a <code>secret</code>.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-bot-deployment</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-bot</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">my-bot</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">my-bot</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-bot</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">dockerhubrepo/my-bot:tag</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">PORT</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;80&quot;</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MICROSOFT_APP_ID</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">secretKeyRef:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">microsoft-bot-app</span><br>              <span class="hljs-attr">key:</span> <span class="hljs-string">app-id</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MICROSOFT_APP_PASSWORD</span><br>          <span class="hljs-attr">valueFrom:</span><br>            <span class="hljs-attr">secretKeyRef:</span><br>              <span class="hljs-attr">name:</span> <span class="hljs-string">microsoft-bot-app</span><br>              <span class="hljs-attr">key:</span> <span class="hljs-string">app-password</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-bot-service</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">my-bot</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p>Create the secret:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /your/secrets/directory<br><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&#x27;your-id&#x27;</span> &gt; ./app-id<br><span class="hljs-built_in">echo</span> -n <span class="hljs-string">&#x27;your-password&#x27;</span> &gt; ./app-password<br>kubectl create secret generic microsoft-bot-app --from-file=./app-password --from-file=./app-id<br></code></pre></td></tr></table></figure><h2 id="Enable-Cluster-HTTPS-Ingress"><a href="#Enable-Cluster-HTTPS-Ingress" class="headerlink" title="Enable Cluster HTTPS Ingress"></a>Enable Cluster HTTPS Ingress</h2><p>This step is probably the most convoluted, but once you’re up and running, it should require much intervention. I’m not going to rewrite all the steps (there are many) but follow <a href="https://docs.microsoft.com/en-us/azure/aks/ingress">this walkthrough</a> for enabling HTTPS ingress on AKS.</p><blockquote><p>Note: Be sure to use <code>letsencrypt-prod</code> - the Bot Emulator and Azure Bot Service will not work unless the bot is hosted under a trusted certificate.</p></blockquote><p>If you’re following the anove walkthrough, you’ll need to customise your http ingress routes.</p><p>Modify the K8s Ingress object to look something like this:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">my-bot-ingress</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">certmanager.k8s.io/cluster-issuer:</span> <span class="hljs-string">letsencrypt-prod</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">tls:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">my-dns-name.australiaeast.cloudapp.azure.com</span><br>    <span class="hljs-attr">secretName:</span> <span class="hljs-string">tls-secret</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">my-dns-name.australiaeast.cloudapp.azure.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/bot</span><br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">my-bot-service</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p>That’s it, you’re done. You should be able to connect to your bot at <code>https://my-dns-name.australiaeast.cloudapp.azure.com/bot/api/messages</code></p><h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><p>You can see a full sample <a href="https://github.com/xtellurian/halp-bot">on github</a></p><h2 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h2><h3 id="The-bot-doesn’t-respond-at-all…"><a href="#The-bot-doesn’t-respond-at-all…" class="headerlink" title="The bot doesn’t respond at all…"></a>The bot doesn’t respond at all…</h3><p>Check the validity of the certificate by navigating to your https url in a browser. If the browser doesn’t trust the certificate, your ingress isn’t configured properly. Check the issuer of the certificate.</p><h3 id="The-bot-says-I’m-unauthorized…"><a href="#The-bot-says-I’m-unauthorized…" class="headerlink" title="The bot says I’m unauthorized…"></a>The bot says I’m unauthorized…</h3><p>Check the values of MICROSOFT_APP_ID and MICROSOFT_APP_PASSWORD. They should be the same in the <a href="https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-connector-concepts?view=azure-bot-service-3.0#bot-connector-service">Bot Service Connector</a> and in your code. The password is hidden inside a kubernetes secret.</p><h3 id="Something-is-wrong…"><a href="#Something-is-wrong…" class="headerlink" title="Something is wrong…"></a>Something is wrong…</h3><p>You can get the logs from your container with the following command</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ kubectl logs --selector=app=my-bot<br>restify listening to http://[::]:80<br>Yes, this service is alive<br>recieved a message<br>Replying: [conversationUpdate event detected]<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Smarter NPCs with Natural Language Processing</title>
    <link href="/2018/05/23/smarter-npcs-with-natural-language-processing/"/>
    <url>/2018/05/23/smarter-npcs-with-natural-language-processing/</url>
    
    <content type="html"><![CDATA[<h2 id="What-happened-in-Pokemon"><a href="#What-happened-in-Pokemon" class="headerlink" title="What happened in Pokemon?"></a>What happened in Pokemon?</h2><p>I remember Pokemon on GameBoy. An excellent game with many characters. Like all games (till now - more on that soon) the conversations were somewhat forced. The most creative moment was choosing your name in the beginning. Almost all my interactions with non-player chracters (NPC) involved multiple choice answers at best, and pre-canned conversations at worst.</p><p><img src="/images/NLU/Pokemonconversationscreenshot.png" alt="Screenshot of a simple Yes or No answer to a question in Pokemon for Gameboy"></p><h2 id="Games-have-Evolved"><a href="#Games-have-Evolved" class="headerlink" title="Games have Evolved"></a>Games have Evolved</h2><p>A decade after Pokemon was first released on Gameboy, Fallout 3 was one of the most popular games in the world. For all its quality graphics and cool story, the NPC interations remain remarkably unchanged.</p><p><img src="/images/NLU/fallout3multiplechoice.jpg" alt="Screenshot from Fallout 3 showing multiple choice answers"></p><h2 id="We-have-the-technology-We-can-do-better"><a href="#We-have-the-technology-We-can-do-better" class="headerlink" title="We have the technology. We can do better"></a>We have the technology. We can do better</h2><p>What if you could actually talk to NPCs? Well, now you can!</p><h3 id="What-is-Natural-Language-Understanding"><a href="#What-is-Natural-Language-Understanding" class="headerlink" title="What is Natural Language Understanding?"></a>What is Natural Language Understanding?</h3><blockquote><p>the application of computational techniques to the analysis and synthesis of natural language and speech.</p></blockquote><p>NLU, sometimes called Natural Language Processing (NLP), are methods for processing and using natural human speech or text in classical algorithms. Recent technological breakthroughs in Deep Learning have turbocharged NLU, and now you can use it in your own game or application.</p><script type="text/javascript" src="https://ssl.gstatic.com/trends_nrtr/1420_RC05/embed_loader.js"></script> <script type="text/javascript"> trends.embed.renderExploreWidget("TIMESERIES", {"comparisonItem":[{"keyword":"deep learning","geo":"","time":"today 5-y"}],"category":0,"property":""}, {"exploreQuery":"date=today%205-y&q=deep%20learning","guestPath":"https://trends.google.com:443/trends/embed/"}); </script> <h3 id="Sounds-hard…"><a href="#Sounds-hard…" class="headerlink" title="Sounds hard…"></a>Sounds hard…</h3><p>Not really, check this out.</p><p>LUIS - the Language Understanding and Intelligence Service from Microsoft Azure - is super simple to use. You can follow <a href="https://docs.microsoft.com/en-us/azure/cognitive-services/luis/luis-get-started-create-app">this tutorial</a> and get started in just 10 minutes!</p><p>Aside: if you’re in Australia, make sure you head to the au.luis.ai domain.</p><h3 id="What’s-LUIS-the-quick-version"><a href="#What’s-LUIS-the-quick-version" class="headerlink" title="What’s LUIS - the quick version"></a>What’s LUIS - the quick version</h3><p>LUIS is a web service, invoked via a REST endpoint, that converts sentences (called ‘utterances’) like this:</p><p><code>Order me 2 pizzas</code></p><p>into data structures like this:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>   <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;Order me 2 pizzas&quot;</span>,<br>   <span class="hljs-string">&quot;topScoringIntent&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;intent&quot;</span>: <span class="hljs-string">&quot;FoodOrder&quot;</span>,<br>       <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0.9999981</span><br>   &#125;,<br>   <span class="hljs-string">&quot;intents&quot;</span>: [<br>       &#123;<br>           <span class="hljs-string">&quot;intent&quot;</span>: <span class="hljs-string">&quot;FoodOrder&quot;</span>,<br>           <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0.9999981</span><br>       &#125;,<br>       &#123;<br>           <span class="hljs-string">&quot;intent&quot;</span>: <span class="hljs-string">&quot;None&quot;</span>,<br>           <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0.0604290478</span><br>       &#125;,<br>       &#123;<br>           <span class="hljs-string">&quot;intent&quot;</span>: <span class="hljs-string">&quot;Reminder&quot;</span>,<br>           <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0.00177723425</span><br>       &#125;<br>   ],<br>   <span class="hljs-string">&quot;entities&quot;</span>: [<br>       &#123;<br>           <span class="hljs-string">&quot;entity&quot;</span>: <span class="hljs-string">&quot;2&quot;</span>,<br>           <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;builtin.number&quot;</span>,<br>           <span class="hljs-string">&quot;startIndex&quot;</span>: <span class="hljs-number">9</span>,<br>           <span class="hljs-string">&quot;endIndex&quot;</span>: <span class="hljs-number">9</span>,<br>           <span class="hljs-string">&quot;resolution&quot;</span>: &#123;<br>               <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;2&quot;</span><br>           &#125;<br>       &#125;,<br>       &#123;<br>           <span class="hljs-string">&quot;entity&quot;</span>: <span class="hljs-string">&quot;pizzas&quot;</span>,<br>           <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;FoodType&quot;</span>,<br>           <span class="hljs-string">&quot;startIndex&quot;</span>: <span class="hljs-number">11</span>,<br>           <span class="hljs-string">&quot;endIndex&quot;</span>: <span class="hljs-number">16</span>,<br>           <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0.8928091</span><br>       &#125;<br>   ]<br>&#125;<br></code></pre></td></tr></table></figure><p>If you’re making a game or an app, and you can make web requests, then you can have NPCs that respond to natural language!</p><h2 id="Now-for-the-good-part"><a href="#Now-for-the-good-part" class="headerlink" title="Now for the good part"></a>Now for the good part</h2><p>Modern games are much more sophisticated than Gameboy Pokemon and Fallout 3. Cutting edge games are now in virtual reality (VR) on platforms like <a href="https://www.vive.com/">Vive</a>, <a href="https://www.oculus.com/">Oculus</a>, and <a href="https://www.microsoft.com/en-au/windows/windows-mixed-reality">Windows Mixed Reality</a>. But we’re starting to use VR for other interesting applications.</p><h3 id="Experience-a-New-Language-in-VR-with-V-KAIWA"><a href="#Experience-a-New-Language-in-VR-with-V-KAIWA" class="headerlink" title="Experience a New Language in VR with V-KAIWA"></a>Experience a New Language in VR with V-KAIWA</h3><p><a href="http://www.v-kaiwa.com/en/home/">V-KAIWA</a> are building an amazing tool for students to experience language learning in VR. Beyond building stylised worlds and engaging story lines, V-KAIWA are building customisable conversational NPCs. Let’s break that down.</p><h4 id="Conversational-NPCs"><a href="#Conversational-NPCs" class="headerlink" title="Conversational NPCs"></a>Conversational NPCs</h4><p>As the name suggests, a conversational NPC is a character with which you can converse. OK, so they aren’t going to pass a <a href="https://en.wikipedia.org/wiki/Turing_test">Turing test</a>, but they can respond to natural language. Ask the hot dog vendor on the street for a hot dog, and you’ll get one! Ask a stranger for directions, and they’ll help! But if you ask a stranger for the meaning of life - of course you’ll get a silly answer (actually that’s kind of realistic).</p><h4 id="Customisable-NPCs"><a href="#Customisable-NPCs" class="headerlink" title="Customisable NPCs"></a>Customisable NPCs</h4><p>V-KAIWA let’s language teachers customise the way their students can converse with NPCs. How does this work in practice? Imagine a language class on recognising descriptions of people and objects. The teacher can describe a person (a woman in a jacket) and name an item (a newspaper) and the students must complete a scenario in the virtual world. The teacher can build precisely that conversation scenario in V-KAIWA’s designer tool!</p><p><img src="/images/NLU/vkaiwadesigner.gif" alt="Creating an NPC interaction definition in the V-KAIWA interaction designer"></p><p>When the student find the newspaper, he can talk with the woman.</p><blockquote><p><em>Student</em>: Here’s the newspaper you asked for.<br><em>Woman in Jacket</em>: Thanks, I was looking for one of those.</p></blockquote><p>It’s almost too easy.</p><h4 id="Sugar-on-top"><a href="#Sugar-on-top" class="headerlink" title="Sugar on top"></a>Sugar on top</h4><p>By using speech-to-text and speech synthesis tools, V-KAIWA make every NPC interaction aural. You can speak directly to NPCs, and they speak back. LUIS means you can speak naturally. <a href="https://docs.microsoft.com/en-us/windows/mixed-reality/gaze-targeting">Gaze</a> means you speak to the NPC you’re looking at.</p><p><img src="/images/NLU/vkaiwaarchitecture.png" alt="System design of V-KAIWAs customisable conversational NPCs"></p><h3 id="I-want-that"><a href="#I-want-that" class="headerlink" title="I want that!"></a>I want that!</h3><p>Well you can have it! There’s a great blog written by some of my collegues at <a href="http://www.roadtomr.com/2018/05/08/2508/natural-language-for-simulations/">Road to MR</a> describing how to use LUIS in your Unity project. They’ve created a great Unity Package you can use to get started quickly. </p><p>What about the designer? It’s also open source and <a href="https://github.com/xtellurian/v-kaiwa-designer">available on github</a></p><h2 id="CSE-Hacks"><a href="#CSE-Hacks" class="headerlink" title="CSE Hacks"></a>CSE Hacks</h2><p>This work was a collaboration between Microsoft and V-KAIWA. Big thanks to them for letting me work on their exciting product.</p><p><blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Seiya presenting at <a href="https://twitter.com/Microsoft?ref_src=twsrc%5Etfw">@Microsoft</a> <a href="https://twitter.com/Microsoft?ref_src=twsrc%5Etfw">@microsoft</a> Mixed Reality Hackfest - our beginners product did a complete 180 (in a good way!) - full demo video coming soon 😉 <br><br>And special props <a href="https://twitter.com/xtellurian?ref_src=twsrc%5Etfw">@xtellurian</a> for being part of V-KAIWA for the week 🤓 <a href="https://t.co/bmhUpQItKC">pic.twitter.com/bmhUpQItKC</a></p>&mdash; V-KAIWA (@v_kaiwa) <a href="https://twitter.com/v_kaiwa/status/997417548852310017?ref_src=twsrc%5Etfw">May 18, 2018</a></blockquote></p><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Building Xamarin.Forms Chatbots with Bot Framework Direct Line API</title>
    <link href="/2018/03/11/xamarin-chatbots/"/>
    <url>/2018/03/11/xamarin-chatbots/</url>
    
    <content type="html"><![CDATA[<p>One of the best things about building chat bots with Microsoft Bot Framework is being able to have a single code base for all the channels supported by the Bot Connector, like Slack, Skype, Facebook and even an embedded HTML interface. But what if you want to make your own client? Well, in that case you can use the <a href="https://docs.microsoft.com/en-us/bot-framework/rest-api/bot-framework-rest-direct-line-3-0-concepts">Bot Framework DirectLine API</a>.</p><p><img src="https://docs.microsoft.com/en-us/bot-framework/media/channels/connect-to-channels.png" alt="Screenshot of the Bot Framework Dashboard"></p><h2 id="Build-a-Bot"><a href="#Build-a-Bot" class="headerlink" title="Build a Bot"></a>Build a Bot</h2><p>There are lots of good tutorials on how to get started writing bots using the <a href="https://github.com/Microsoft/BotBuilder">Microsoft Bot Builder SDK</a>. If you’re just getting started, try the excellent <a href="https://github.com/MissionMarsFourthHorizon/operation-max">Mission Mars Tutorials</a>.</p><p>Once you’ve got the basics, you should try the <a href="https://github.com/MSFTAuDX/BotBoiler">Bot Boiler Framework</a> in NodeJS. It provides tools for dependency injection, testing, deployment to Azure Functions, and more. I won’t go into how to write a good chatbot - this article assumed that your bot code already exists.</p><h3 id="Enable-Direct-Line"><a href="#Enable-Direct-Line" class="headerlink" title="Enable Direct Line"></a>Enable Direct Line</h3><p>Configure your channels in the <a href="https://dev.botframework.com/">Bot Portal</a> and enable the Direct Line channel, then <a href="https://docs.microsoft.com/en-us/bot-framework/portal-configure-channels">configure your Direct Line Channel</a>, and get your direct line secret. You’ll need that secret later on.</p><p><img src="https://docs.microsoft.com/en-us/bot-framework/media/direct-line-configure.png" alt="Direct Line Config Sample"></p><h3 id="Using-Xamarin-Forms-Project"><a href="#Using-Xamarin-Forms-Project" class="headerlink" title="Using Xamarin.Forms Project"></a>Using Xamarin.Forms Project</h3><h4 id="Why-Xamarin-and-Forms"><a href="#Why-Xamarin-and-Forms" class="headerlink" title="Why Xamarin and Forms?"></a>Why Xamarin and Forms?</h4><p>If you’ve never heard of <a href="https://www.xamarin.com/">Xamarin</a>, then you’ve been missing out. Xamarin is a toolset, originally built using the Mono Framework, that allows developers to write common C# (and F#) and deploy applications to many operating systems and environments. The most popular are Android, iOS, and Windows.</p><p>​<br><img src="https://www.xamarin.com/content/images/pages/platform/code-sharing@2x.png" alt="Xamarin Framework Overview"></p><p>Xamarin Forms is a set of API’s written in Xamarin that let us write common user interface code. Basically, I can run exactly the same app on Android, iOS and Windows. Cool!</p><h4 id="File-gt-New-Project-VS2017"><a href="#File-gt-New-Project-VS2017" class="headerlink" title="File &gt; New Project (VS2017)"></a>File &gt; New Project (VS2017)</h4><p>I’m going using Visual Studio 2017. You can <a href="https://www.visualstudio.com/downloads/">download the community version</a> for free. DotNet Standard is supported in VS2015 but not in earlier versions.</p><p><a href="https://developer.xamarin.com/guides/xamarin-forms/getting-started/hello-xamarin-forms/quickstart/">This guide</a> can help you create your first Xamarin Forms project. The short version is:</p><ul><li><p>Create a new Xamarin.Forms project</p></li><li><p>Select PCL as your method for sharing code</p></li><li><p>Create a blank app (not a master detail page)</p></li></ul><h4 id="Move-to-dotnet-standard"><a href="#Move-to-dotnet-standard" class="headerlink" title="Move to dotnet standard"></a>Move to dotnet standard</h4><p>​<a href="https://xamarinhelp.com/upgrade-pcl-net-standard-class-library/">Xamarin.Forms recently started supporting DotNet Standard</a> (hooray!). <a href="https://docs.microsoft.com/en-us/dotnet/standard/net-standard">.Net Standard</a> is the latest and greatest standard for writing cross platform C#. It provides a common set of API’s that <strong>work everywhere</strong>. Better yet, it improves dramatically over the previous standard (Portable Class Libraries, or PCL) as there’s no platform targets, just backwards compatible versions of .NET Standard.</p><p>​Before we get started, we’ve got to change the way we’re sharing code in our Xamarin project, by <a href="https://xamarinhelp.com/upgrade-pcl-net-standard-class-library/">converting to .NET Standard</a>. We’ll change our PCL project (not the Android, iOS, or UWP projects) by deleting <code>packages.config</code> then unloading the project and replacing the contents of the .csproj file with the following code:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">Project</span> <span class="hljs-attr">Sdk</span>=<span class="hljs-string">&quot;Microsoft.NET.Sdk&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">PropertyGroup</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TargetFramework</span>&gt;</span>netstandard1.3<span class="hljs-tag">&lt;/<span class="hljs-name">TargetFramework</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">PackageTargetFallback</span>&gt;</span>$(PackageTargetFallback);portable-win+net45+wp8+win81+wpa8<span class="hljs-tag">&lt;/<span class="hljs-name">PackageTargetFallback</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">PropertyGroup</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">Project</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>You’ll have to re-add and install any NuGet Packages, but at this stage it should only be the Xamarin.Forms package.</p><h4 id="Import-DirectLine-Client"><a href="#Import-DirectLine-Client" class="headerlink" title="Import DirectLine Client"></a>Import DirectLine Client</h4><p>​The best thing about targetting .NET Standard is we can use the official NuGet package for interacting with the DirectLine API!</p><p>​<code>Install-Package Microsoft.Bot.Connector.DirectLine -Version 3.0.2</code></p><h4 id="Communicate-with-your-Bot"><a href="#Communicate-with-your-Bot" class="headerlink" title="Communicate with your Bot"></a>Communicate with your Bot</h4><p>Here’s a screenshot of what we expect our Bot UI to look like:</p><p><img src="/images/xamarinchatbots/botscreenshot.png" alt="Chat Bot Sreenshot"></p><p>Before continuing, I suggest you read <a href="https://docs.microsoft.com/en-us/bot-framework/rest-api/bot-framework-rest-direct-line-3-0-concepts">Key Concepts in DirectLine API 3.0</a></p><p>First, we create a microservice class for interacting with the bot. We inject the direct line secret (from the portal) into the constructor.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-keyword">private</span> DirectLineClient _client;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BotService</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> directLineSecret</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(directLineSecret)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ArgumentNullException(<span class="hljs-string">&quot;Direct Line Secret is required&quot;</span>);<br>    &#125;<br><br>    _client = <span class="hljs-keyword">new</span> DirectLineClient(directLineSecret);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>There are two important public methods: CreateConversation and SendMessage.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-built_in">string</span>&gt; <span class="hljs-title">StartConversation</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> isDefault = <span class="hljs-literal">true</span></span>)</span><br>&#123;<br>    <span class="hljs-keyword">var</span> conversation = <span class="hljs-keyword">await</span> _client.Conversations.StartConversationAsync();<br><br>    PollForMessages(conversation);<br>    <span class="hljs-keyword">if</span>(isDefault || _defaultConversation == <span class="hljs-literal">null</span>)<br>    &#123;<br>        _defaultConversation = conversation;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> conversation.ConversationId;<br>&#125;<br><br><br><span class="hljs-comment">// Poll the API every second to check for new messages</span><br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">PollForMessages</span>(<span class="hljs-params">Conversation conversation</span>)</span><br>&#123;<br>    Device.StartTimer(<span class="hljs-keyword">new</span> TimeSpan(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>), () =&gt;<br>    &#123;<br>        <span class="hljs-keyword">var</span> activitySet = _client.Conversations.GetActivities( conversation.ConversationId, _watermark);<br>        <span class="hljs-keyword">var</span> activities = activitySet?.Activities.Where(_ =&gt; _.From.Id != GetUserId());<br>        _watermark = activitySet.Watermark; <span class="hljs-comment">// watermark lets us only get new messages</span><br><br>        <span class="hljs-keyword">if</span> (activities != <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> activity <span class="hljs-keyword">in</span> activities)<br>            &#123;<br>                ActivityReceived?.Invoke(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">new</span> ActivityEventArgs() &#123; Activity = activity &#125;);<br>            &#125;<br><br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>​</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;ResourceResponse&gt; <span class="hljs-title">SendMessage</span>(<span class="hljs-params"> <span class="hljs-built_in">string</span> message, <span class="hljs-built_in">string</span> conversationId = <span class="hljs-literal">null</span></span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (conversationId == <span class="hljs-literal">null</span>)<br>    &#123;<br>        conversationId = GetDefaultConversationId(); <span class="hljs-comment">// get default if not specified</span><br>    &#125;<br><br><span class="hljs-comment">// create a new Activity to send to the Bot</span><br><br>    SentActivity = <span class="hljs-keyword">new</span> Activity<br>    &#123;<br>        From = GetChannelAccount(),<br>        Text = message,<br>        Type = ActivityTypes.Message<br><br>    &#125;;<br><br>    <span class="hljs-comment">// invoke an event signalling an activity has been sent</span><br>    ActivitySent?.Invoke(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">new</span> ActivityEventArgs() &#123; Activity = SentActivity &#125;);<br><br>    <span class="hljs-keyword">var</span> response = <span class="hljs-keyword">await</span> _client.Conversations.PostActivityAsync(conversationId, SentActivity);<br>    <span class="hljs-keyword">return</span> response;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>​</p><h4 id="Monitor-the-Conversation"><a href="#Monitor-the-Conversation" class="headerlink" title="Monitor the Conversation"></a>Monitor the Conversation</h4><p>We need to make a user interface for chatting with the bot. We add these two events to our <a href="https://github.com/xtellurian/Botframework.Xamarin/blob/master/Microsoft.Botframework.Xamarin/Microsoft.Botframework.Xamarin/Implementations/BotService.cs">BotService class</a> in order to track when things happen.</p><p>​</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> EventHandler&lt;ActivityEventArgs&gt; ActivitySent;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> EventHandler&lt;ActivityEventArgs&gt; ActivityReceived;<br><br></code></pre></td></tr></table></figure><p>​</p><p>These two events are going to let us update our UI any time we send or receive a message from the Bot. We add every activity we send/ receive to an observable collection that we bind to a ListView. Actually, we’re going to use a custom UI element, described below, but it inherits from the standard Xamarin Forms ListView.</p><p>The <a href="https://github.com/xtellurian/Botframework.Xamarin/blob/master/Microsoft.Botframework.Xamarin/Microsoft.Botframework.Xamarin/ViewModels/ConversationViewModel.cs">ConversationViewModel</a> class contains the following property:</p><p><code>public ObservableCollection&lt;Activity&gt; Messages &#123; get; set; &#125;</code></p><p>​</p><p>and in our XAML view, we create a listview that binds to that collection.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">ListView</span> <span class="hljs-attr">x:Name</span>=<span class="hljs-string">&quot;ChatListView&quot;</span></span><br><span class="hljs-tag"></span><br><span class="hljs-tag">    <span class="hljs-attr">ItemsSource</span>=<span class="hljs-string">&quot;&#123;Binding Messages&#125;&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ItemTemplate</span>=<span class="hljs-string">&quot;&#123;StaticResource activityDataTemplateSelector&#125;&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">SeparatorVisibility</span>=<span class="hljs-string">&quot;None&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">HasUnevenRows</span>=<span class="hljs-string">&quot;True&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">customViews:ChatListView.Effects</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">effects:ListViewScrollToBottomEffect</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">effects:ListViewStackFromBottomEffect</span> /&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">customViews:ChatListView.Effects</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">ListView</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>There are two interesting parts of this XAML:</p><p>​</p><ul><li><p><code>ItemTemplate=&quot;&#123;StaticResource activityDataTemplateSelector&#125;&quot;</code></p></li><li><p><code>&lt;customViews:ChatListView.Effects&gt;</code></p></li></ul><h4 id="Data-Templates"><a href="#Data-Templates" class="headerlink" title="Data Templates"></a>Data Templates</h4><p>We need to tell the difference between messages _to_ and <em>from</em> the bot, and render those messages differently so the user can tell the difference. In order to do that, we use a Data Template Selector, which we referenced in the above XAML.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ActivityDataTemplateSelector</span> : <span class="hljs-title">DataTemplateSelector</span><br>&#123;<br>    <span class="hljs-keyword">public</span> DataTemplate SenderTemplate &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>    <span class="hljs-keyword">public</span> DataTemplate ReceiverTemplate &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br>    <span class="hljs-keyword">public</span> DataTemplate AdaptiveCardsTemplate &#123; <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> DataTemplate <span class="hljs-title">OnSelectTemplate</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> item, BindableObject container</span>)</span><br>    &#123;<br>       <span class="hljs-keyword">var</span> activity = (Activity)item;<br><br>       <span class="hljs-keyword">if</span> (activity.Attachments != <span class="hljs-literal">null</span> &amp;&amp;<br>           activity.Attachments.Any(<br>               m =&gt; m.ContentType == <span class="hljs-string">&quot;application/vnd.microsoft.card.adaptive&quot;</span>))<br>           &#123;<br>               <span class="hljs-keyword">return</span> AdaptiveCardsTemplate;<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (activity <span class="hljs-keyword">is</span> SendPhotoActivity)<br>           &#123;<br>               <span class="hljs-keyword">if</span> (((SendPhotoActivity)activity).Path != <span class="hljs-literal">null</span> &amp;&amp; ((SendPhotoActivity)activity).Path != <span class="hljs-built_in">string</span>.Empty)<br>               &#123;<br>                   <span class="hljs-keyword">return</span> SentPhotoAttachmentTemplate;<br>               &#125;<br>          &#125;<br><br>        <span class="hljs-keyword">return</span> ((Activity)item).From.Name == <span class="hljs-string">&quot;MyName&quot;</span> ? SenderTemplate : ReceiverTemplate;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Then, in XAML, we bind those three public properties to views which will be rendered at runtime depending on the type of activity. For example, our receiver activity template looks like this:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">DataTemplate</span> <span class="hljs-attr">x:Key</span>=<span class="hljs-string">&quot;receiverActivityTemplate&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ViewCell</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">Grid</span> <span class="hljs-attr">Padding</span>=<span class="hljs-string">&quot;10, 2, 10, 2&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">Frame</span> <span class="hljs-attr">HasShadow</span>=<span class="hljs-string">&quot;True&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">VerticalOptions</span>=<span class="hljs-string">&quot;FillAndExpand&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">HorizontalOptions</span>=<span class="hljs-string">&quot;FillAndExpand&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">Margin</span>=<span class="hljs-string">&quot;5&quot;</span></span><br><span class="hljs-tag">                   <span class="hljs-attr">CornerRadius</span>=<span class="hljs-string">&quot;15&quot;</span>&gt;</span><br><br>                 <span class="hljs-tag">&lt;<span class="hljs-name">StackLayout</span></span><br><span class="hljs-tag">                      <span class="hljs-attr">Orientation</span>=<span class="hljs-string">&quot;Vertical&quot;</span></span><br><span class="hljs-tag">                      <span class="hljs-attr">VerticalOptions</span>=<span class="hljs-string">&quot;FillAndExpand&quot;</span></span><br><span class="hljs-tag">                      <span class="hljs-attr">HorizontalOptions</span>=<span class="hljs-string">&quot;FillAndExpand&quot;</span>&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">md:MarkdownView</span> <span class="hljs-attr">Markdown</span>=<span class="hljs-string">&quot;&#123;Binding Text&#125;&quot;</span> /&gt;</span><br>                      <span class="hljs-tag">&lt;<span class="hljs-name">Label</span> <span class="hljs-attr">Text</span>=<span class="hljs-string">&quot;&#123;Binding From.Name&#125;&quot;</span></span><br><span class="hljs-tag">                          <span class="hljs-attr">FontSize</span>=<span class="hljs-string">&quot;Micro&quot;</span></span><br><span class="hljs-tag">                          <span class="hljs-attr">HorizontalOptions</span>=<span class="hljs-string">&quot;EndAndExpand&quot;</span> /&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">StackLayout</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">Frame</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">Grid</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ViewCell</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">DataTemplate</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>Which we bind to the selector as follows:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><br><span class="hljs-tag">&lt;<span class="hljs-name">dataTemplates:ActivityDataTemplateSelector</span></span><br><span class="hljs-tag">    <span class="hljs-attr">x:Key</span>=<span class="hljs-string">&quot;activityDataTemplateSelector&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">ReceiverTemplate</span>=<span class="hljs-string">&quot;&#123;StaticResource receiverActivityTemplate&#125;&quot;</span> /&gt;</span><br></code></pre></td></tr></table></figure><p>​</p><h4 id="Using-Effects"><a href="#Using-Effects" class="headerlink" title="Using Effects"></a>Using Effects</h4><p>Effects are a great way to add platform specific features to your Xamarin Forms UI. Jim Bennet has a really great (and short!) blog post on <a href="https://www.jimbobbennett.io/effects-in-xamarin-forms/">how to implement Effects in Xamarin Forms</a>.</p><p>One effect you might find useful is listing messages from the bottom.</p><p>In Android, we need to access the native listview control. With effects, it’s easy!</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DroidListViewStackFromBottomEffect</span> : <span class="hljs-title">PlatformEffect</span><br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnAttached</span>()</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> listView = Control <span class="hljs-keyword">as</span> Android.Widget.ListView;<br><br>        <span class="hljs-keyword">if</span> (listView != <span class="hljs-literal">null</span>)<br>        &#123;<br>            listView.StackFromBottom = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDetached</span>()</span>&#123;&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><p>Check out the <a href="https://github.com/xtellurian/Botframework.Xamarin">GitHub repo</a> to see all three effects we implemented: Stacking from bottom, auto scrolling, and a keyboard ‘done’ button.</p><h4 id="Using-Custom-Renderers"><a href="#Using-Custom-Renderers" class="headerlink" title="Using Custom Renderers"></a>Using Custom Renderers</h4><p>Another cool feature of Xamarin Forms are <a href="https://developer.xamarin.com/guides/xamarin-forms/application-fundamentals/custom-renderer/">custom renderers</a>. Every UI Container in Xamarin Forms renders to a platform specific UI Control. For example, a <a href="https://developer.xamarin.com/guides/xamarin-forms/user-interface/listview/">Xamarin Forms ListView</a> when running in Android, is actually rendered to a native <a href="https://developer.android.com/guide/topics/ui/layout/listview.html">Android ListView</a>. By writing a custom renderer, we can control the way our UI is converted to native controls.<br>​</p><h4 id="Working-with-Adaptive-Cards"><a href="#Working-with-Adaptive-Cards" class="headerlink" title="Working with Adaptive Cards"></a>Working with Adaptive Cards</h4><p>We’re going to use a custom renderer to render <a href="http://adaptivecards.io/">adaptive cards</a> received in a conversation. Adaptive Cards are a great way to serialize a display and share it across multiple user experiences. The same adaptive card may be rendered on Facebook Messenger or Microsoft Teams, and though it contains the same information and functionality, the platform renders it to look though it’s a native implementation (because it is).</p><h6 id="Download-and-Build-the-Adaptive-Card-Renderer-for-Xamarin-Forms"><a href="#Download-and-Build-the-Adaptive-Card-Renderer-for-Xamarin-Forms" class="headerlink" title="Download and Build the Adaptive Card Renderer for Xamarin Forms"></a>Download and Build the Adaptive Card Renderer for Xamarin Forms</h6><p>Adaptive Cards by Microsoft is a 100% open source project. <a href="https://github.com/Microsoft/AdaptiveCards">Check them out on GitHub</a>.</p><p>Adaptive Cards are designed to render anywhere that your users are. The following native platform renderers are under development right now.</p><p>Android -&gt; <a href="https://github.com/Microsoft/AdaptiveCards/tree/master/source/android">Source</a> <img src="https://img.shields.io/vso/build/Microsoft/8d47e068-03c8-4cdc-aa9b-fc6929290322/17418.svg" alt="Build status"></p><p>​<br>HTML -&gt; <a href="https://github.com/Microsoft/AdaptiveCards/tree/master/source/html">Source</a> <img src="https://img.shields.io/vso/build/Microsoft/8d47e068-03c8-4cdc-aa9b-fc6929290322/18415.svg" alt="Build Status"></p><p>iOS -&gt; <a href="https://github.com/Microsoft/AdaptiveCards/tree/master/source/ios">Source</a> <img src="https://img.shields.io/vso/build/Microsoft/8d47e068-03c8-4cdc-aa9b-fc6929290322/16990.svg" alt="Build status"></p><p>WPF -&gt; <a href="https://github.com/Microsoft/AdaptiveCards/tree/master/source/dotnet">Source</a> <img src="https://img.shields.io/vso/build/Microsoft/8d47e068-03c8-4cdc-aa9b-fc6929290322/18203.svg" alt="Build Status"></p><p>UWP -&gt; <a href="https://github.com/Microsoft/AdaptiveCards/tree/master/source/uwp">Source</a> <img src="https://img.shields.io/vso/build/Microsoft/8d47e068-03c8-4cdc-aa9b-fc6929290322/16850.svg" alt="Build Status"></p><p>Xamarin.Forms -&gt; <em>No ETA yet</em> - <a href="https://github.com/Microsoft/AdaptiveCards/tree/master/source/dotnet">Source</a>- Alpha</p><p>At time of writing, the Xamarin Forms Renderer is still in alpha - which means we’ve included a pre-built library in the /lib directory of our project.</p><h6 id="Rendering-Adaptive-Cards"><a href="#Rendering-Adaptive-Cards" class="headerlink" title="Rendering Adaptive Cards"></a>Rendering Adaptive Cards</h6><p>We implemented a custom renderer &amp; data template combination that allowed us to render adaptive cards directly in the ListView.</p><p>There are three important parts to rendering the card.</p><p>First we need to select the correct Data Template based on the incoming activity. These lines in ActivityDataTemplateSelector achieve just that</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-keyword">if</span> (activity.Attachments != <span class="hljs-literal">null</span> &amp;&amp;<br>    activity.Attachments.Any(m =&gt; m.ContentType ==<br>    <span class="hljs-string">&quot;application/vnd.microsoft.card.adaptive&quot;</span>))<br><br>&#123;<br>    <span class="hljs-keyword">return</span> AdaptiveCardsTemplate;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Second, we create a custom view inheriting from StackLayout</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AdaptiveCardLayout</span> : <span class="hljs-title">StackLayout</span><br>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> EventHandler OnAction;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InvokeOnAction</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, ActionEventArgs args</span>)</span><br>    &#123;<br>        Device.BeginInvokeOnMainThread(() =&gt;<br>        &#123;<br>            MessagingCenter.Send(<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;AdaptiveCardAction&quot;</span>,<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>This custom view is bound, via a data template definition in XAML.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataTemplate</span> <span class="hljs-attr">x:Key</span>=<span class="hljs-string">&quot;adaptiveCardsTemplate&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ViewCell</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">customViews:AdaptiveCardLayout</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">ViewCell</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">DataTemplate</span>&gt;</span><br><br>...<br><br><span class="hljs-tag">&lt;<span class="hljs-name">dataTemplates:ActivityDataTemplateSelector</span> <span class="hljs-attr">x:Key</span>=<span class="hljs-string">&quot;activityDataTemplateSelector&quot;</span></span><br><span class="hljs-tag"></span><br><span class="hljs-tag">    <span class="hljs-attr">AdaptiveCardsTemplate</span>=<span class="hljs-string">&quot;&#123;StaticResource adaptiveCardsTemplate&#125;&quot;</span></span><br><span class="hljs-tag"></span><br></code></pre></td></tr></table></figure><p>​</p><p>Thirdly, we use the adaptive cards renderer to actually render the card.</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><br><span class="hljs-comment">// this code is shortened for brevity, and should not be used.</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">DroidAdaptiveCardLayoutRenderer</span> : <span class="hljs-title">ViewRenderer</span>&lt;<span class="hljs-title">AdaptiveCardLayout</span>, <span class="hljs-title">Android.Views.View</span>&gt;<br>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnElementChanged</span>(<span class="hljs-params">ElementChangedEventArgs&lt;AdaptiveCardLayout&gt; e</span>)</span><br>    &#123;<br>        <span class="hljs-keyword">var</span> activity = e.NewElement.BindingContext <span class="hljs-keyword">as</span> Bot.Connector.DirectLine.Activity;<br>        <span class="hljs-keyword">var</span> renderer = <span class="hljs-keyword">new</span> AdaptiveCards.Rendering.AdaptiveCardRenderer();<br>        <span class="hljs-keyword">var</span> cardAttachments = activity.Attachments.Where(<br>          m =&gt; m.ContentType == <span class="hljs-string">&quot;application/vnd.microsoft.card.adaptive&quot;</span>);<br><br>        <span class="hljs-keyword">var</span> jObject = (JObject)attachment.Content;<br><br>        <span class="hljs-keyword">var</span> xaml = renderer.RenderCard(card);<br><br>        e.NewElement.Children.Add(xaml.View);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>You can see our droid <a href="https://github.com/xtellurian/Botframework.Xamarin/blob/master/Microsoft.Botframework.Xamarin/Microsoft.Botframework.Xamarin.Android/Renderers/DroidAdaptiveCardLayoutRenderer.cs">renderer on GitHub</a>.</p><h4 id="Sample-Project"><a href="#Sample-Project" class="headerlink" title="Sample Project"></a>Sample Project</h4><p>​We used these patterns and code in a 3 day hack with the Australian tax office. Hey look, its a robot that helps you with your tax!</p><p>​<img src="/images/xamarinchatbots/ATO_App.gif" alt="A Sample Conversation"></p><p>​You can see the <a href="https://github.com/xtellurian/Botframework.Xamarin">complete solution on GitHub</a></p><p>​</p><h4 id="Further-Reading"><a href="#Further-Reading" class="headerlink" title="Further Reading"></a>Further Reading</h4><ul><li><p><a href="http://adaptivecards.io/">Adaptive Cards</a></p></li><li><p><a href="https://docs.microsoft.com/en-us/bot-framework">Bot Framework Docs</a></p></li><li><p><a href="https://docs.microsoft.com/en-us/bot-framework/rest-api/bot-framework-rest-direct-line-3-0-concepts">Bot Framework DirectLine API</a></p></li><li><p><a href="https://github.com/MSFTAuDX/BotBoiler">Bot Boiler Framework</a></p></li><li><p><a href="https://www.visualstudio.com/downloads/">Download Visual Studio</a></p></li><li><p><a href="https://xamarinhelp.com/upgrade-pcl-net-standard-class-library/">Xamarin.Forms &amp; DotNet Standard</a></p></li><li><p><a href="https://docs.microsoft.com/en-us/dotnet/standard/net-standard">.Net Standard</a></p></li><li><p><a href="https://xamarinhelp.com/upgrade-pcl-net-standard-class-library/">Upgrade a PCL to .NET Standard</a></p></li><li><p><a href="https://www.jimbobbennett.io/effects-in-xamarin-forms/">Xamarin.Forms Effects</a></p></li></ul><p>​</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Digital Assistants &amp; Azure Event Grid</title>
    <link href="/2018/03/04/digital-assistants-azure-eventgrid/"/>
    <url>/2018/03/04/digital-assistants-azure-eventgrid/</url>
    
    <content type="html"><![CDATA[<p><img src="/images/robot.jpg" alt="Robot Assistant Cartoon"></p><h2 id="The-Digital-World"><a href="#The-Digital-World" class="headerlink" title="The Digital World"></a>The Digital World</h2><p>The digital world exists at once everyone and nowhere. Things are happening there, at the speed of light. Those events effect our lives, but as physical beings it takes us time and effort to response. A digital assistant responds to events in the digital world, helping you that pervasive yet ephemeral environment. </p><p>As the digital world becomes busier and noisier, we need cloud-scale technologies that allow us to respond to events in real time. Azure event grid proves exactly that type of medium, for events on the web and in the cloud. Using event grid and bot framework, we can build bots that observe events in the grid, let you know when important things are happening, and provide options for responding.</p><h2 id="Azure-Event-Grid"><a href="#Azure-Event-Grid" class="headerlink" title="Azure Event Grid"></a>Azure Event Grid</h2><p>Azure Event Grid allows you to easily build applications with event-based architectures. You select the Azure resource you would like to subscribe to, and give the event handler or WebHook endpoint to send the event to. Event Grid has built-in support for events coming from Azure services, like storage blobs and resource groups. Event Grid also has custom support for application and third-party events, using custom topics and custom webhooks.</p><p><img src="https://docs.microsoft.com/en-us/azure/event-grid/media/overview/functional-model.png" alt="Azure Event Grid Sources and Handers Diagram"></p><p>More publishers and handlers are being added. Event Grid is currently in preview, but is expected to be in GA by the end of 2017.</p><p>The best features of event grid are:</p><ul><li>Cloud Scale: Can support millions of events per second</li><li>Cloud Pricing: GA pricing will be $0.60 / million events</li><li>Low Latency: Events are delivered usually within a second</li><li>Flexible Schema: Arbitrary JSON payloads</li><li>Guaranteed Delivery: Retry policy and eventual consistency</li></ul><h2 id="Bots-in-the-Grid"><a href="#Bots-in-the-Grid" class="headerlink" title="Bots in the Grid"></a>Bots in the Grid</h2><p>Conversations are growing in popularity as an interface with the digital world. Conversations naturally morph between the synchronous and asynchronous, making them a perfect fit for how we interact with modern applications. </p><h3 id="Responding-to-Digital-Events"><a href="#Responding-to-Digital-Events" class="headerlink" title="Responding to Digital Events"></a>Responding to Digital Events</h3><p>The following shows how to listen for events with Microsoft Bot Framework. In this example, I’ll be using an ASP.NET bot, so this code will work for any ASP.NET application, and the same pattern holds for most web applications.</p><h3 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h3><p>Subscribing your bot to events is actually very simple. Just implement an http endpoint that receives incoming webhooks.</p><p><img src="/content/images/2017/10/boteventgridarchitecture.png" alt="Architecture Diagram for Connecting Bots to Event Grid"></p><h4 id="Incoming-Event-Data-Structure"><a href="#Incoming-Event-Data-Structure" class="headerlink" title="Incoming Event Data Structure"></a>Incoming Event Data Structure</h4><p>Incoming events, via webhook, are delivered by the body of an HTTP Post. The following is an example:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs .language-json">&#123;[<br>  &#123;<br>    &quot;Data&quot;: &#123;<br>      &quot;Correlation&quot;: &#123;<br>        &quot;ExternalReferenceId&quot;: &quot;9c551c4f-9a73-4565-8590-b4b81b074dfb&quot;<br>      &#125;,<br>      &quot;To&quot;: &#123;<br>        &quot;Id&quot;: &quot;myUserId&quot;,<br>        &quot;DisplayName&quot;: &quot;Rian&quot;<br>      &#125;,<br>      &quot;Amount&quot;: 150.0,<br>      &quot;Message&quot;: &quot;Whatever you like&quot;<br>    &#125;,<br>    &quot;Id&quot;: &quot;fbfaab9e-a328-4c77-bee7-8fb95264d4fd&quot;,<br>    &quot;Subject&quot;: &quot;custom\\value&quot;,<br>    &quot;EventType&quot;: 0,<br>    &quot;EventTime&quot;: &quot;2017-10-25T23:01:37.3456283Z&quot;,<br>    &quot;topic&quot;: &quot;/SUBSCRIPTIONS/XXXXXXXX-XXXX-XXXX-XXXX-XX/RESOURCEGROUPS/YOUR-GROUP/PROVIDERS/MICROSOFT.EVENTGRID/TOPICS/YOUR_TOPIC&quot;<br>  &#125;<br>]&#125;<br></code></pre></td></tr></table></figure><p>Since this is a custom event, everything in the <em>Data</em> field is yours to play with. The other top level fields define how the event is processed within event grid.</p><h3 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h3><p>Event Grid can provide up to a million events per second, which could be the biggest DDOS cannon on the public cloud! Luckily, when you register a webhook subscriber, the first request contains a challenge that must be responded to correctly, else the subscription fails. The challenge request has the same structure as a normal event, however the <em>data</em> field contains a validation code that must be returned in the HTTP response.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs .language-json">[&#123;<br>  &quot;id&quot;: &quot;2d1781af-3a4c-4d7c-bd0c-e34b19da4e66&quot;,<br>  &quot;topic&quot;: &quot;/subscriptions/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;,<br>  &quot;subject&quot;: &quot;&quot;,<br>  &quot;data&quot;: &#123;<br>    &quot;validationCode&quot;: &quot;512d38b6-c7b8-40c8-89fe-f46f9e9622b6&quot;<br>  &#125;,<br>  &quot;eventType&quot;: &quot;Microsoft.EventGrid.SubscriptionValidationEvent&quot;,<br>  &quot;eventTime&quot;: &quot;2017-08-06T22:09:30.740323Z&quot;<br>&#125;]<br></code></pre></td></tr></table></figure><p>You must return the validation code as a validation response:<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs .language-json">&#123;<br>  &quot;validationResponse&quot;: &quot;512d38b6-c7b8-40c8-89fe-f46f9e9622b6&quot;<br>&#125;<br></code></pre></td></tr></table></figure></p><p>Its also best practice to protect your webhook endpoint with a secret key. Its quite simple: just provide that key when setting up the subscription, and the request path contains that key before processing any event. Your webhook path should look like:</p><p><code>https://&lt;base_url&gt;/api/events?secret=YOUR_SECRET_KEY</code></p><h3 id="Handling-Incoming-Events-with-ASP-NET"><a href="#Handling-Incoming-Events-with-ASP-NET" class="headerlink" title="Handling Incoming Events with ASP.NET"></a>Handling Incoming Events with ASP.NET</h3><p>The key method on your controller accepts an HTTP Post and should return a 200 or 202, to ensure that event grid knows that the event has been received, and won’t retry.<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs .language-csharp">public async Task&lt;HttpResponseMessage&gt; Post([FromBody]dynamic e)<br>&#123;<br>  foreach ( var azEvent in e)<br>  &#123;<br>    if (azEvent?.data?.validationCode != null)<br>    &#123;<br>      return Request.CreateResponse(HttpStatusCode.OK, new &#123; validationResponse = x.data.validationCode &#125;);<br>    &#125;<br>    else<br>    &#123;<br>      HandleEvent(azEvent);<br>    &#125;<br>  &#125;<br>  return Request.CreateResponse(HttpStatusCode.OK);<br>&#125;<br></code></pre></td></tr></table></figure><br><a href="https://gist.github.com/xtellurian/1ee357452668d7c3f46b83410c84435c">See this gist for the full controller code</a></p><h3 id="Creating-and-Subscribing-to-Topics-and-Events"><a href="#Creating-and-Subscribing-to-Topics-and-Events" class="headerlink" title="Creating and Subscribing to Topics and Events"></a>Creating and Subscribing to Topics and Events</h3><p>Event Grid topics are Azure resources, and must be placed in an Azure resource group. The resource group is a logical collection into which Azure resources are deployed and managed.</p><p>Follow these steps in the Azure Portal to use custom topics:</p><p><img src="/content/images/2017/10/eventgridportal.PNG" alt="Creating Topics and Subs in the Azure Portal"></p><ol start="0"><li>Create an Azure Resource Group if you don’t have one already.</li><li>Under <em>More Services</em> search for event grid, and select <strong>Event Grid Topics</strong></li><li>Create a new topic</li><li>Under <em>More Services</em> search for event grid, and select <strong>Event Grid Subscriptions</strong></li><li>Create a new subscription, and enter the endpoint you created as a webhook.</li></ol><p>You can follow detailed steps <a href="https://docs.microsoft.com/en-us/azure/event-grid/custom-event-quickstart-portal">here</a></p><h3 id="Dev-amp-Test-using-Ngrok"><a href="#Dev-amp-Test-using-Ngrok" class="headerlink" title="Dev &amp; Test using Ngrok"></a>Dev &amp; Test using Ngrok</h3><p>You can also get events directly to your local machine using <a href="https://ngrok.com/">ngrok</a>. When you run a local server, there are listeners on local ports e.g. <code>localhost:44313/api/events</code>. Using ngrok, you can expose your local server to the web. After installing ngrok, run the following command: <code>ngrok http 44313 -host-header=&quot;localhost:44313&quot;</code> and you’ll have a public url you can then set as a new subscription.</p><p><img src="/content/images/2017/10/ngrokexample.PNG" alt="Ngrok Screenshot"></p><p>Add your public ngrok url, with events path and key, as a new event subscription: <code>https://xxxxxx.ngrok.io/api/events?key=YOUR_SECRET_KEY</code></p><h3 id="Proactive-Bot-Messages"><a href="#Proactive-Bot-Messages" class="headerlink" title="Proactive Bot Messages"></a>Proactive Bot Messages</h3><p>Now your bot web server is receiving events, you can use that power to send proactive messages to users affected by that event. For example, you may generate an event every time users post a comment. You can <a href="https://docs.microsoft.com/en-us/bot-framework/nodejs/bot-builder-nodejs-proactive-messages">read the documentation</a> of proactive messages on Microsoft Bot Framework, or there are <a href="https://github.com/MicrosoftDX/botFramework-proactiveMessages">several samples on GitHub</a>.</p><p>A great use case for proactive messages is billing and payment requests. Every service provider wants a fast, reliable and easy billing experience for their customers. Imagine if your company’s digital assistant could proactively reach out to your customers, let them know their bill’s are almost due, and provide them simple ways to pay.</p><p><img src="/content/images/2017/10/PaymentRequest.PNG" alt="Example of a Proactive Message for a Payment Request"></p><h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Azure Event Grid is a great way to trigger proactive messages from intelligent bots - but there’s so much more it can do. It’s designed for modern applications, particularly those using serverless, because of its ability to scale. It lets you connect on-premises and cloud infrastructure via a fast and reliable messaging. It’s really fast, and super easy to use. 10/10 - would use again.</p><h3 id="Further-Reading"><a href="#Further-Reading" class="headerlink" title="Further Reading"></a>Further Reading</h3><ul><li><a href="https://gist.github.com/xtellurian/1ee357452668d7c3f46b83410c84435c">ASP.NET Controller for Event Grid Webhooks</a></li><li><a href="https://docs.microsoft.com/en-us/azure/event-grid/">Event Grid</a></li><li><a href="https://docs.microsoft.com/en-us/azure/event-grid/custom-event-quickstart-portal">Event Grid - Quickstart on the Azure Portal</a></li><li><a href="https://ngrok.com/">ngrok</a></li><li><a href="https://docs.microsoft.com/en-us/bot-framework/">Bot Framework</a></li><li><a href="https://docs.microsoft.com/en-us/bot-framework/nodejs/bot-builder-nodejs-proactive-messages">Proactive Messages Documentation</a></li><li><a href="https://github.com/MicrosoftDX/botFramework-proactiveMessages">Proactive Messages Samples</a></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>OpenAI Gym on Windows</title>
    <link href="/2018/02/07/openai-windows/"/>
    <url>/2018/02/07/openai-windows/</url>
    
    <content type="html"><![CDATA[<p>OpenAI’s Gym is officially only supported on Linux and OSX. Follow these steps to get up and running on Windows using <a href="https://msdn.microsoft.com/en-au/commandline/wsl/install_guide">Windows Subsystem for Linux</a></p><ol><li><p>Update to the latest version of Windows (&gt;version 1607, “Anniversary Update”)</p></li><li><p>Enable Windows Subsystem for Linux (WSL)</p></li><li><p>Open cmd, run <code>bash</code></p></li><li><p>Install python &amp; gym (using sudo, and NOT PIP to install gym). So by now you should probably be able to run things and get really nasty graphics related errors. This is because WSL doesn’t support any displays, so we need to fake it.</p></li><li><p>Install vcXsrv, and run it (you should just have a little tray icon)</p></li><li><p>In bash <code>export DISPLAY=:0</code><br>Now when you run it you should get a display to pop-up, there may be issues related to graphics drivers. Sadly, this is where the instructions diverge if you don’t have an NVIDIA graphics card.<br>(If you’ve got a nvidia graphics card) -&gt;<br><code>sudo apt-get install nvidia-304 nvidia-prime</code></p></li><li><p>Load this into test.py</p><pre><code class="hljs">// test.pyimport gymif __name__ == &quot;__main__&quot;:env = gym.make(&quot;SpaceInvaders-v0&quot;)env.reset()for _ in range(1000):    env.render()    env.step(env.action_space.sample())</code></pre></li><li><p><code>python test.py</code></p></li></ol><p>SPACE INVADERS!<br><img src="/content/images/2017/08/Capture2.PNG" alt="space invaders playing"></p><p>My thanks to <a href="https://github.com/openai/gym/issues/11">this thread</a> </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Installing Tensorflow and Keras on Windows</title>
    <link href="/2018/01/28/tensorflow-keras-windows/"/>
    <url>/2018/01/28/tensorflow-keras-windows/</url>
    
    <content type="html"><![CDATA[<p>Installing Tensorflow was once challenging, bordering on impossible. Now… not so much.</p><h2 id="Install-Anaconda"><a href="#Install-Anaconda" class="headerlink" title="Install Anaconda"></a>Install Anaconda</h2><p><a href="https://www.continuum.io/what-is-anaconda">Anaconda</a> is a data science ecosystem, giving users access to all sorts of toolkits and frameworks. <a href="https://www.continuum.io/downloads">Download</a> the Anaconda installer for Windows (it’s ~500MB) and install. See, that was easy!</p><h2 id="Install-C-Build-Tools"><a href="#Install-C-Build-Tools" class="headerlink" title="Install C++ Build Tools"></a>Install C++ Build Tools</h2><p>If you don’t already have them installed, you’ll need to download and install the <a href="http://landinghub.visualstudio.com/visual-cpp-build-tools">Visual C++ Build Tools</a>.</p><h2 id="TF-amp-Keras"><a href="#TF-amp-Keras" class="headerlink" title="TF &amp; Keras"></a>TF &amp; Keras</h2><p>Anaconda provides a simple tool for installing TF in a virtual environment. Open up a terminal prompt and type <code>conda create -n tensorflow python=3.5</code> . This will create a virtual environment for called tensorflow that you’ll use to encapsulate all your tensorflow libraries!</p><p><a href="https://conda-forge.org/">Conda Forge</a> is a community led source for conda packages. It provides a simple way to install the packages we’re looking for!</p><p>Activate your environment using <code>activate tensorflow</code>.</p><p>Now, we’re going to install tf and keras into our virtual anaconda environment using packages from Conda Forge. With your tensorflow env active:<br><code>conda install -c conda-forge keras tensorflow</code></p><p>Now use <code>conda list</code> to see all packages installed in your env.</p><p><img src="/content/images/2017/08/Capture.PNG" alt="an image"></p><p>Look at that! Tensorflow and Keras are both installed!</p><h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><p>Copy the following code into a new file called kerastest.py</p><pre><code class="hljs">from keras.models import Sequentialfrom keras.layers import Dense, Dropout, Activationfrom keras.optimizers import SGDmodel = Sequential()model.add(Dense(64, input_dim=20, init=&apos;uniform&apos;))model.add(Activation(&apos;tanh&apos;))model.add(Dropout(0.5))model.add(Dense(64, init=&apos;uniform&apos;))model.add(Activation(&apos;tanh&apos;))model.add(Dropout(0.5))model.add(Dense(10, init=&apos;uniform&apos;))model.add(Activation(&apos;softmax&apos;))sgd = SGD(lr=0.1, decay=1e-6, momentum=0.9, nesterov=True)model.compile(loss=&apos;categorical_crossentropy&apos;,          optimizer=sgd,          metrics=[&apos;accuracy&apos;])print(&apos;done&apos;)</code></pre><p>If it works, then your environment is ready to go.</p><p>Get Learning!</p><h3 id="More-Info"><a href="#More-Info" class="headerlink" title="More Info"></a>More Info</h3><p><a href="https://uoa-eresearch.github.io/eresearch-cookbook/recipe/2014/11/20/conda/">Conda Environments</a></p><p><a href="https://www.tensorflow.org/install/install_windows">Installing TF on Windows</a></p><p><a href="https://keras.io/#installation">Installing Keras</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>What happened to the decentralised internet?</title>
    <link href="/2017/11/23/what-happened-to-the-internet/"/>
    <url>/2017/11/23/what-happened-to-the-internet/</url>
    
    <content type="html"><![CDATA[<p>In the late 20th century, the pioneers of the internet and a new generation of online radicals envisioned a future where free communication, access to information, and equality of access made people increasingly fair minded, intelligent, and empathetic. In 2016, that optimism seems like naïveté. So what happened? </p><p> In the early days, internet technology remained in the hands of large organisations, governments and militaries. Computers were large and expensive, and commonly used for transferring scientific or research data across multiple sites. During this phase, a key design goal was to build a non-centralised network; basically to build a robust communication system that could survive major catastrophes (aka nuclear war). Almost nobody at this time was thinking of the social impact of the technology. The whole point was to build networks that didn’t have a centre.</p><p>​A second phase began in the late nineties, which is known today as Internet 1.0. At this time, in the 1990s and early 2000s, the internet was growing, but nobody really knew what was going to happen. The exuberance of the dot-com boom (then bust) typifies the period. Any internet company could have skyrocketing valuations with almost no relation to the real world. At the same time as business talked itself into an irrational boom, thousands of people were creating basic websites, chat services were started, file and image sharing became popular, as did notice boards and eBay. This is really the climactic ‘wild west’ of the internet. You could say or post almost anything on some dark corner of the internet, and nobody would ever know. Unlike today, traffic wasn’t dominated by a few big players. The inherently decentralised nature of the technology had created a social space that was also decentralised. Fertile ground for new ventures, but extremely hard to monetise any new services. Nevertheless, enthusiasm over the popularity of the new tech fuelled the crash at the turn of the millennium.</p><p>​&gt; Cyber-utopians ambitiously set out to build a new and improved United Nations, only to end up with a digital Cirque du Soleil. – <em>Evgeny Morozov</em></p><p>​It was during this phase that a new consciousness developed regarding the possibilities created by this new, equal and free social space. An utopian vision of free communication, uninhibited by big media, governments or existing institutions. The internet is uniquely disposed to utopian visions. Unlike other technologies that seek an idealised transformation of reality (though it does this also), the internet creates the possibility of a new virtual space - a virtual space that at least in theory can be made perfect. These ideas were perhaps best expressed by Richard Barbrook in his essay <a href="http://www.metamute.org/editorial/articles/californian-ideology">The Californian Ideology</a>, which expressed precisely the ideological tension between the free democratic potential of the left, and the free market potential of the right, that had developed in west coast USA in the late 20th century.</p><p>​&gt; The Californian ideology offers a fatalistic vision of the natural and inevitable triumph of the hi-tech free market. – <em>Richard Barbrook</em></p><blockquote><p>The convergence of media, computing and telecommunications would inevitably result in an electronic direct democracy - the electronic agora - in which everyone would be able to express their opinions without fear of censorship. – <em>Richard Barbrook</em></p></blockquote><p>So at the new millennium there coexisted two very different ideas about the future of the internet, that in some sense mapped to a left/right ideological split within the dominant political paradigm. But there had to be a reckoning, and as in the past and in other social arenas, the combatants were those individuals in favour of decentralisation, those intent on aggregating power for themselves. Ultimately, the driver of change into “Web 2.0” was the monetisation of these emerging technologies.</p><blockquote><p>Web 1.0 was making the Internet for people, Web 2.0 is making the Internet better for companies.</p></blockquote><p> <em>– Jeff Bezos, CEO Amazon.com</em></p><p>​Companies and governments weren’t going to sit around and watch media, communication, politics and eventually power slip from their hands. Enter Web 2.0. Jeff Bezos calls Web 2.0 “making the Internet better for companies”. We are living in this period of the social history of the internet. Rather than enjoying the dream of a decentralised internet, today the internet is highly centralised. Most people use the internet every day, but use perhaps 2 or 3 services, perhaps Facebook, Google and Snapchat. These very companies are busy buying up any small competitor in order to maintain their monopolies, and these monopolies allow them to monetise their users, mostly through advertising (with some notable exceptions). Indeed, the class of technology billionaires eschew even the rhetoric of their libertarian predecessors, preferring monopoly to competition.</p><blockquote><p>Competition Is for Losers. If you want to create and capture lasting value, look to build a monopoly. – <em>Peter Thiel</em></p></blockquote><p>Today, there is an alliance between the large internet monopolies and governments around the world. Every large internet company (including Google and Facebook) provide intelligence organisations with <em>direct</em> access to their data. In return, they get to use that information to model your personality and target you with advertising. This alliance is completely reversing the idealised model of Internet 1.0: a centralised, controlled, monitored internet that cements the power of existing corporations and governments. But we shouldn’t be too surprised. There have been many new communication technologies over the centuries. Every one has been appropriated by powerful institutions, or occasionally, like Facebook or Google, those upstarts challenging the existing order were integrated into a new order resembling the old. Centralisation of information technologies means the centralisation of political power, a power that can easily be turned against the public. After all, what political organisation could survive being labelled as purveyors of ‘fake news’ by Facebook or Google?</p><p>​As always, the challenges to rational, democratic social organisation are great. Our communication technology facilitates creation and dissemination of information at a rate orders of magnitude larger than at any time in the past. In the face of an information flood, it is quite natural for people to harden in their views; for their ideology to become more rigid. These are common features of politics today: compromise is almost  impossible, polarisation is common, identities are solidifying, intellectuals are disparaged, and experts ignored. Even attempts to improve the situation seem desperate and dangerous: the targeting of ‘fake news’ by Google and Facebook are just as likely to further centralise their power as to improve public knowledge. </p><p>​I don’t have the answer on how to reclaim the dreams of the early internet. There are questions that require creative answers. How to limit polarisation and mitigate the effects of echo chambers? How to mediate and balance the growing power of the corporate owners of these new technologies? And perhaps most importantly, who to listen to, and who to ignore, amid this deluge of information flooding our world.</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Learning to Trade</title>
    <link href="/2017/11/11/learning-to-trade/"/>
    <url>/2017/11/11/learning-to-trade/</url>
    
    <content type="html"><![CDATA[<p>Australia’s energy market has found itself in a particularly strange place. The Finkel report, released in early June, recommends legislating for a Low Emissions Target (LET) and though there are political interests for coal fired generation (CFG), CFG will inevitably decline as alternative technologies displace it. Solar power is now one of the cheapest forms of new electricity generation, and battery storage is about to burst onto the scene. All this at a time when average wholesale prices are rising sharply, and each factor contributing to a sense of price volatility. </p><p><img src="/images/learningtotrade/NEM-WeighedAveragePrices-1.jpg" alt="NEM-WeighedAveragePrices-1"></p><p>A newly emerging technology space is that of operating grid-scale battery energy storage. But operating grid-scale battery storage is a tricky business. If you’ve never heard of the NEM before, read <a href="https://www.aemo.com.au/-/media/Files/PDF/National-Electricity-Market-Fact-Sheet.pdf">this factsheet (pdf)</a> from the Australian Energy Market Operator (AEMO). </p><blockquote><p>All electricity sales are traded through the NEM. It is a wholesale market and prices fluctuate in response to supply and demand at any point in time.</p></blockquote><blockquote><p>To manage price volatility, retailers and generators often enter into hedging contracts to fix the price for future electricity sales. – <em>NEM Fact Sheet</em></p></blockquote><h2 id="Battery-Strategy"><a href="#Battery-Strategy" class="headerlink" title="Battery Strategy"></a>Battery Strategy</h2><h4 id="Baseline"><a href="#Baseline" class="headerlink" title="Baseline"></a>Baseline</h4><p>Imagine we’re operating a battery in the NEM. Let’s develop a strategy (a set of rules by which we decide whether to buy, sell, or sit) in order to maximise our profit. On the face of it, our task is simple: buy/ charge electricity when the price is low, and sell/ discharge when the price is high. As the network is currently dominated by CFG, power is usually cheap at 4am (everyone is asleep but the coal plants are still operating) and expensive at 7am and 7pm (when everyone’s making breakfast or dinner, doing the washing, watching TV etc). This will be our baseline strategy to which we can compare any of our other strategies, since its trivially simply to implement. It works because there’s a pattern in the market that follows our daily rhythms. However there are some major weaknesses to this approach: its vulnerable to changing patterns in the market, it can’t be used in hedging contracts, and our battery might be discharged before prices spike.</p><h4 id="Adapting-to-price"><a href="#Adapting-to-price" class="headerlink" title="Adapting to price"></a>Adapting to price</h4><p>In fact, it’s the last weakness I mentioned above that’s the biggest problem. The NEM is a fairly transparent and competitive market, which means that many generators are operating at cost for most of the time. There are gas plants (known as peaking gas plants) that literally remain dormant most of the time, and turn on only when the price spikes and generation becomes profitable. Batteries have the same advantage as gas plants (they can turn on fast) and could also take advantage of high prices. Similarly, we’d also like to take advantage of low prices to charge our battery.</p><h4 id="Augmented-Baseline"><a href="#Augmented-Baseline" class="headerlink" title="Augmented Baseline"></a>Augmented Baseline</h4><p>An augmented baseline strategy takes into account price changes. Rather than simply charging/ discharging at particular times, we account for the difference between prices (probably running average price to minimise noise) at charge time and discharge time. If the price different is not above some threshold, then we prefer to sit (remain charged) and wait for a better price. In order to run this strategy properly, we’d need to account for the state of charge of the battery, and the self-discharge rate (ie, the rate at which energy leaks out of the battery). It’s important to note that we aren’t predicting any future prices, we’re just comparing with the price we bought at 4am. Our expectation is that by setting our sell threshold at the correct level, we can avoid selling at a low price when we’d prefer to wait a few hours and sell later perhaps at a better price. Optimising this strategy simply requires optimising the threshold values, which must change dynamically over a day in order to encourage a complete discharge by 4am the next morning when we wish to recharge.</p><h4 id="Consider-the-Variables"><a href="#Consider-the-Variables" class="headerlink" title="Consider the Variables"></a>Consider the Variables</h4><p>At this point, we’d do well to consider all the information we’d need to create the <strong>perfect strategy</strong>. Clearly we need the current price, and our current state of charge, but crucially we need <em>all future prices</em>. Knowing all future prices means we can decide whether its worth buying/ selling now so that we can buy/ sell later. The following equation expresses profit as a function of two future prices. Prices are quantised. Subscript j represents charge time and subscript i represent discharge time. Lambda represents a discount factor that prioritises earlier profit. The function can be said to represent a <em>full transaction</em> consisting of buy and sell components.</p><p><img src="/images/learningtotrade/Profit_function.gif" alt="Profit_function"></p><p>Our perfect strategy would be to calcuate this function for all i,j (where i &gt; j), sort the results and execute only those transactions with maximum profit. Note that the number of transactions executed is related to the capacity of the battery and charge/ discharge rates.</p><h4 id="Predictive-Strategy"><a href="#Predictive-Strategy" class="headerlink" title="Predictive Strategy"></a>Predictive Strategy</h4><p>We can’t know for certain all future prices in the NEM, but if we can make a good <em>prediction</em> then we can get close to implementing our perfect strategy. Actually, what we really need is a probabilistic distribution of future prices. I won’t go into detail here about formal decision making strategies with uncertainty, but needless to say it’s an area of active research. For a gentle introduction to the subject, I recommend <a href="https://www.amazon.com/Antifragile-Things-That-Disorder-Incerto/dp/0812979680">Nassim Taleb’s Antifragile</a>. But by weighting our perfect strategy function by probabilistic distributions, we create a strategy that will approximate the perfect strategy as long as our predictions are accurate. </p><blockquote><p>Operating a battery in the NEM is a combination of two machine learning problems: regression and classification.</p></blockquote><p>The insight here is important: with the right strategy <strong>better prediction means bigger profits.</strong></p><p>At this point we can see how the baseline strategy is actually a particular subset of predictive strategy. That is, the case where we set the predictions to be a constant price minimum at 4am and a constant price maximum at 7am and 7pm, with no predictions in between.</p><h3 id="Enter-Machine-Learning"><a href="#Enter-Machine-Learning" class="headerlink" title="Enter Machine Learning"></a>Enter Machine Learning</h3><p>We want to predict the NEM’s market prices, but this is a non-trivial problem. The number of factors influencing price is enormous. A non-exhaustive list includes the weather, events like sports games and concerts, changes to distribution and transmission, coal prices, gas prices, public holidays, and whether the people operating that power plant are having a good day. </p><h4 id="Regression"><a href="#Regression" class="headerlink" title="Regression"></a>Regression</h4><p>Predicting NEM prices falls under a class of problems known as <em><a href="https://en.wikipedia.org/wiki/Regression_analysis">regression</a></em>. In simple terms, regression models the relationship between variables such that, given a number of independent variables, the value of a dependent variable is predicted. Machine learning techniques allow us to introduce literally hundreds or thousands of independent variables (usually called features) into a predictive model. We train this model with data (a training set) in a way that allows us to get extremely accurate predictions. In our context, we want to use as much relevant data as possible in order to predict prices in the NEM.</p><h5 id="Experiment"><a href="#Experiment" class="headerlink" title="Experiment"></a>Experiment</h5><p>I ran a basic experiment using a Bayesian Linear Regression model in Azure Machine Learning Studio. The data used was only price data for 2016, with no other features. That is, the only data used was the date, the time, and the NEM spot price. Using the first half of 2016 as a training set, and the second half as test and validation sets, the model achieved a 99.3% coefficient of determination. Basically, the model <em>predicted NEM spot price extremely accurately</em>. This is an extremely promising result, and one that shows even simple machine learning techniques can deliver useful predictions. </p><p><img src="/images/learningtotrade/experiment_results.jpg" alt="experiment_results"></p><h4 id="Classification"><a href="#Classification" class="headerlink" title="Classification"></a>Classification</h4><p>Operating a battery in the NEM is a combination of two machine learning problems: regression and classification. Classification is a problem in which input features define a particular class. In our case the input features are the current and future prices, and the battery state of charge, while the output classes are buy/ sell/ sit.  In our perfect strategy, we could maximise profit with zero risk because the future was perfectly deterministic and known. However, once we introduce uncertainty with our predictive strategy, the classification problem becomes more difficult. It becomes entirely possible, in fact inevitable, that our classification system makes a mistake. </p><h4 id="Learning-from-Mistakes"><a href="#Learning-from-Mistakes" class="headerlink" title="Learning from Mistakes"></a>Learning from Mistakes</h4><p>One of the huge benefits of machine learning is that we can improve them over time. Retraining models takes significantly less time than the initial training, and we expect that periodic retraining will keep a model up-to-date, as well as improve overall accuracy. </p><h4 id="Contracts"><a href="#Contracts" class="headerlink" title="Contracts"></a>Contracts</h4><p>I mentioned earlier that hedging contracts are used by players in the NEM to minimise possible losses. The beauty of using machine learning to make decisions on whether to buy/ sell/ sit is that it can account for precisely those contracts. Even our predictive strategy couldn’t deal with those, because it only goal was to maximise profit based on price. ML classifications systems can account for as many arbitrary independent variables as you like, and so could make decisions that account for contractual obligations or any other constraint you’d like to impose. </p><p>In fact, another technology that may revolutionise the energy sector is <a href="https://hbr.org/2017/03/how-utilities-are-using-blockchain-to-modernize-the-grid">blockchain</a>. ML based battery strategies could automatically include an arbitrary number of smart contracts and have optimal decision making. Indeed, its possible for a ML decision making tool to make decisions taking many factors into account, not just profit. </p><h4 id="Anomaly-Detection"><a href="#Anomaly-Detection" class="headerlink" title="Anomaly Detection"></a>Anomaly Detection</h4><p>Another common use of machine learning is in anomaly detection. As a subset of the clarification problem, we can use machine learning techniques to predict whether a situation is extraordinary. Anomaly detection is useful in our situation for three use cases. </p><h6 id="Detecting-Anomalous-Market-Activity"><a href="#Detecting-Anomalous-Market-Activity" class="headerlink" title="Detecting Anomalous Market Activity"></a>Detecting Anomalous Market Activity</h6><p>As a battery operator (or actually any player in NEM), we’d love to know when the market might be acting ‘weird’. These are the times when we stand to gain, or lose, a lot of money. Recognising these moments as early as possible might make the all the difference. </p><h6 id="Detecting-Anomalous-Decision-Making"><a href="#Detecting-Anomalous-Decision-Making" class="headerlink" title="Detecting Anomalous Decision Making"></a>Detecting Anomalous Decision Making</h6><p>Assuming we’d deployed a ML tool to make buy/ sell/ sit decisions for us, we’d love to have an independent arbiter watching over those decisions and flagging any that seem strange. A supervising anomaly detection system could monitor hundreds of independent batteries and alert us if one of them starts acting strangely.</p><h6 id="Detecting-Anomalous-Battery-Operation"><a href="#Detecting-Anomalous-Battery-Operation" class="headerlink" title="Detecting Anomalous Battery Operation"></a>Detecting Anomalous Battery Operation</h6><p>In what’s probably the most important application of anomaly detection, we really need to know when our batteries’ hardware starts acting strangely. Be it irregular state of charge, high self-discharge rates or high temperatures, there are a thousand ways for a battery to degrade and affect system performance. Machine learning lets us account for the hundreds of factors that may be early indicators of battery failure and let us act accordingly. Further, if a battery fails in an unexpected way, we can use the data collected during failure to help us predict the next failure.</p><h4 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h4><p>Batteries will play an ever greater role in the NEM and machine learning is already here. Increasing profits generated by batteries will be driven almost entirely by improving price prediction, and the state of the art in prediction is machine learning. </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Drake &amp; Trappist-1</title>
    <link href="/2017/08/21/drake-and-trappist1/"/>
    <url>/2017/08/21/drake-and-trappist1/</url>
    
    <content type="html"><![CDATA[<p><a href="https://www.nasa.gov/press-release/nasa-telescope-reveals-largest-batch-of-earth-size-habitable-zone-planets-around">NASA’s latest announcement</a> is important because of Drake.</p><p><img src="/images/drake/drake-email-smile1.png" alt="drake-email-smile1"></p><p>Wait, not that Drake… this one, <a href="https://en.wikipedia.org/wiki/Drake_equation">Dr Frank Drake</a>:</p><p><img src="/images/drake/Dr._Frank_Drake.jpg" alt="Dr._Frank_Drake"></p><p>He’s most famous for the Drake Equation, which provides a method for estimating the number of active, intelligent and communicating civilisations in the Milky Way Galaxy - i.e. it tells you how many aliens are out there.</p><p><img src="/images/drake/drake-equation.svg" alt="The Drake Equation"></p><h3 id="TRAPPIST-1"><a href="#TRAPPIST-1" class="headerlink" title="TRAPPIST-1"></a>TRAPPIST-1</h3><p><img src="/images/drake/trappist-system-1.jpg" alt="trappist-system-1"></p><p>This planetary system recently discovered has 7 Earth-sized planets orbiting a single star! Three of those planets are orbiting within the <em>habitable zone</em> - the “goldilocks area”, where conditions are just-right to support life. Strangely enough, all these planets are orbiting closer to their star than Mercury is to our own sun. Trappist-1 is an ultra-cool dwarf star. Consequently the planets can be much closer to their star and still may contain liquid water, crucial for life as we know it. </p><p>In the next few years, several space telescopes will observe the system, looking for clues to the development of extra-terrestrial life. Most exciting: the <a href="https://jwst.nasa.gov/">James-Webb Space Telescope</a> scheduled to launch in 2018.</p><blockquote><p>Spitzer, Hubble, and Kepler will help astronomers plan for follow-up studies using NASA’s upcoming James Webb Space Telescope, launching in 2018. With much greater sensitivity, Webb will be able to detect the chemical fingerprints of water, methane, oxygen, ozone, and other components of a planet’s atmosphere. Webb also will analyze planets’ temperatures and surface pressures – key factors in assessing their habitability.</p></blockquote><p>What the Trappist-1 discovery implies is that the average rate of Earth-like planets-per-star may be much higher than we previously thought (the third factor in the Drake equation: ne). There’s a lot of alien worlds out there.</p><p><strong>TL;DR</strong><br>Drake and NASA teamed up to find aliens</p><p><img src="/images/drake/drake_aliens.jpg" alt="drake_aliens"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Review - Our Broken Steps</title>
    <link href="/2017/01/10/review-our-broken-steps/"/>
    <url>/2017/01/10/review-our-broken-steps/</url>
    
    <content type="html"><![CDATA[<p><em>Our Broken Steps</em> is a guide to responsible travel, written by my friend Tamshuk Saha. It’s words resonated with me, as it expressed many of my own thoughts and feelings. Tamshuk addresses both the socially and environmentally destructive practices prevalent in the tourism industry throughout Asia. In the following I present a synopsis of the book, followed by an attempt to express his principles in my own words.</p><h2 id="Our-Broken-Steps-A-Synopsis"><a href="#Our-Broken-Steps-A-Synopsis" class="headerlink" title="Our Broken Steps: A Synopsis"></a>Our Broken Steps: A Synopsis</h2><p>Tamshuk discusses three categories of unethical travel practices:  not-so-eco-friendly travel, humanitarian abuse, and clash of cultures. The book is written in the style of a travel-guide, describing many harmful activities, and providing simple solutions that any tourist could undertake. The book is not long, and I encourage you to read it before traveling in Asia or elsewhere. Its available on <a href="https://www.amazon.com/OUR-BROKEN-STEPS-Insights-Responsible-ebook/dp/B01MZ51V5F">Amazon</a>, and you can follow Tamshuk at his <a href="http://www.tamzexplores.com/">blog</a>.</p><h4 id="The-Environmental"><a href="#The-Environmental" class="headerlink" title="The Environmental"></a>The Environmental</h4><p>It is quite simple to comprehend the effects of tourism on local and global environments. The book focuses on the effects of inappropriate garbage disposal. The aggregation of plastic waste in the pacific ocean (a ‘hidden’ island) is contrasted with an image of beautiful beaches, rivers and forests covered in an unsightly later of garbage. As tourists, this problem is one that <em>get’s in the way</em> of our desire to experience nature’s uncorrupted beauty. Us tourists live in a contradictory world, consuming bottled water while complaining of trash. The prescribed cure in this case is fourfold: follow the instructions of tour operators; pick up your own trash; participate in tours that are explicitly environmentally friendly; and volunteer in eco-conservation projects. But I don’t think this is enough to solve the problem - the global problem - of plastic waste. <a href="https://www.youtube.com/watch?v=9znvqIkIM-A">Watch this video, because Jeff Bridges</a></p><h4 id="The-Social"><a href="#The-Social" class="headerlink" title="The Social"></a>The Social</h4><p>The second section on humanitarian abuse is rather more confronting. The ever growing popularity of sex-tourism, itself often judged as inherently wrong, is linked to a rise in human trafficking and child-sex-slavery. Tamshuk refuses to judge those associated with the sex industry, but of-course condemns the associated horrific practices mentioned above. He places other kinds of tourism-fuelled immoral exploitation in the same category. <a href="https://www.thinkchildsafe.org/thinkbeforevisiting/">Orphanage tourism</a> leads some families in Cambodia to intentionally ‘sell’ their children to (fake) orphanages that take tourists there for photo opportunities. Many other tours sell similar kinds of experiences, including slum tours in India and ‘human safari’ tours in the Andaman Islands. There are three ways to engage in socially responsible travel: volunteer responsibly; choose your tours wisely; and reflect on the nature and effects of sex tourism. </p><h4 id="The-Cultural"><a href="#The-Cultural" class="headerlink" title="The Cultural"></a>The Cultural</h4><p>When people travel across the world and enter an alien culture, their responses are wildly varying. Many people find the experience so unpleasant as to return home and never leave again. However, some expressions of ‘culture shock’ are destructive. These include defacing and destroying monuments or religious artefacts; or wearing culturally insensitive clothing. In these cases, Tamshuk recommends: engage with local people; respect and care for monuments; actively discourage exploitative tourism. This is the most difficult type of responsible travel, since one will certainly confront practices one may find mildly unpleasant to downright appalling. The urge to yell at someone for doing something you find distasteful is something I think many people have experienced. But the responsible thing is to find some way of <em>acting by example</em>, and finding constructive ways of communicating with those you disagree with. Arguing with people in public places (who may not fully understand you anyway) is not the way to build bridges and facilitate learning. </p><h3 id="Going-Deeper-The-‘Golden-Rule’-is-not-Enough"><a href="#Going-Deeper-The-‘Golden-Rule’-is-not-Enough" class="headerlink" title="Going Deeper: The ‘Golden Rule’ is not Enough"></a>Going Deeper: The ‘Golden Rule’ is not Enough</h3><p>Tamshuk’s prescriptions are of course practical and achievable, and the reader is encouraged to undertake them at any time when travelling as a tourist. But reasoning behind them implies a deeper moral prerogative. It is not enough to naively obey the ‘golden rule’ - to treat others as you wish to be treated. Equally important is to understand the effects of ones actions on others, society and the environment. Only when we understand the consequences of our actions can we really act properly. Only when one knows the true effects of orphanage tourism can one avoid hurting children. Only when we understand that plastic pollutes planet earth for thousands of years do we avoid littering. Only when we choose to truly engage with foreign cultures can we have genuine relationships. Fundamentally, good intentions are not enough and can even harm when applied without knowledge. </p><p>This moral result is not limited to travel or tourism. It is applicable to everyday life, wherever one finds oneself. And that is why this book is important - not because travel is special, but because we must attempt to understand the consequences of our actions, as tourists or otherwise.</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>The Power of Stone</title>
    <link href="/2016/12/23/the-power-of-stone/"/>
    <url>/2016/12/23/the-power-of-stone/</url>
    
    <content type="html"><![CDATA[<p>In Rajasthan, fortified towns are separated by stretches of arid land. Centuries of sand are piled against their walls. Tourist infantry swarm the ancient structure, as rickshaw cavalry pick off the weak or confused. These aged military structures, now abandoned to hawkers and rickshaws, stand as a reminder of a different time; when the foundations of power were driven deep into the ground. </p><p>Trading caravans travelled from Persia, through the mountain passes, and crossing the Indus river marked their entrance into India. Where the river flows into the Arabian sea, ships arrive at port having travelled far from the gulf coast or the peninsula to the south. Just east of the delta, fertile river plains turn quickly into dry desert. Swapping their donkeys for camels, merchants drove across that dusty land, seeking the markets of Rajasthan: the land of kings. Across this land trade routes spread like cracks through glass. </p><hr><p><strong>The Desert of Jaisalmer</strong></p><p><img src="/images/india/Jaisalmer-Fort-Pano.jpg" alt="Jaisalmer-Fort-Pano"></p><p>In the east Jaisalmer arises out of the desert: a haven of golden sandstone built to protect the interests on one ruling family, by the town’s namesake Rawal Jaisal (ce 1156). For hundreds of years, it’s warehouses were filled with rarities from Egypt, Persia, Arabia, Africa and China. The town fell to Ala-ud-din in the 13th century. Two centuries later Akbar, the greatest Moghul emperor, would subsume the town into his empire, sealing the union by marriage. The arrival of the British in Bombay marked the beginning of Jaisalmer’s decline, as trade routes shifted south. The ancient path’s fate was sealed in 1947, when partition created that great imaginary wound on the face of the earth: the Indian-Pakistani border, which today lies only 100km away, cutting through the heart of the desert. </p><p><img src="/images/india/colourful-women.jpg" alt="colourful-women"></p><p>The surrounding desert defines the town. Scattered throughout are small villages clinging to life next to a well or bore hole. The people of the desert cover themselves in bright colours, many of which are symbols of their <em>jati</em>. For most of history, the value of the desert was found almost solely in the goods travelling between east and west. Today, that ancient economy is lost, but partially replaced by tourists taking camel safaris. As in many parts of the world, modernity has arrived by force, smashing ancient roles. Rather than dominating regional trade, camels and their riders now ferry tourists between luxury tents and a sand dune worthy of a selfie. </p><hr><p><strong>The Jauhar of Chittorgarh</strong></p><p><img src="/images/india/Chittorgarh_fort.JPG" alt="Chittorgarh_fort"></p><p>In the land of kings, those who built fortresses called themselves Rajputs - the sons of kings. Each clan claimed descent from a god: some claimed a solar ancestry and called themselves <em>Suryavanshi</em>; <em>Chandravanshi</em> from the moon; and <em>Agnivanshi</em> from fire. Many Rajputs workshipped Durga, a goddess with many arms, who would single-handedly (so to speak) destroy the armies of her enemies and decapitate their leader, usually depicted as a demon.</p><p>At Chittorgarh, the modern mind is disturbed by the rituals of Jauhar, performed at the moment of immanent defeat. Night falls, and brahmin priests begin to chant Vedic mantras. The Rajput women, wearing their wedding dresses, would suicide by self immolation, often taking their children. In the morning the men would commit the <em>saka</em>. Bathing and donning saffron robes, they  smeared the ashes of the funeral pyres on their foreheads,and charged into battle in the face of almost certain death - to destroy their enemies, or destroy themselves. When the fortress fell to Akbar in 1567, those final moments were recorded:</p><blockquote><p>Two armies raised their lances<br>They formed ambuscades, and drew up in line<br>They were all iron-fisted, biters of steel,<br>All were famous and were clad in iron<br>The heroes brandished swords red with blood<br>One was yielding up his life, another was flying,<br>They mowed down with swords the elephant-trunks<br>You’d say serpents were being rained down from the clouds<br>The Commander on a mighty, raging elephant<br>Continually assailed the bow string<br>One paid off his debt of hate with lance and sword<br>Sometimes the heart was riven, sometimes the breast was consumed<br>Tulips were painted by his dagger<br>There was a rain of rings from the heroes’ armour.</p></blockquote><p>–Abu’l Fazl, chronicler of the great Mughal emperor Akbar</p><hr><p><strong>The Jains of Kumblegarh</strong></p><p><img src="/images/india/kumbhalgarh-pano.jpg" alt="kumbhalgarh-pano"></p><p>In a land of competing religions and sects, Rajput kings sponsored Jain temples deep inside and nearby their forts. The Rajputs and most of their people worshipped of Shiva or Vishnu, so why would they build temples to a competing sect? To understand, one must first appreciate the passionate non-violence (ahimsa) of the Jainas. Proscription of violence against all animals put most medieval professions (farming, soldiering, etc) out of reach. Consequently, Jainas became a powerful trading community. In these arid lands, trade was the dominant economic force, and controlling it was a priority of all Rajput rulers. To those ends, Jainism was sponsored by many Rajas in order to curry favour amongst the trading community and reap the expected rewards. </p><p>At Kumblegarh, there are around 300 Jain temples, several of which you can see in the photo above. These buildings stand as reminders of the importance of trade, as well as the tolerance of the Hindu rulers and people. I can’t imagine any European ruler allowing the construction of hundreds of non-Christian religious buildings near a palace or castle. </p><hr><p><img src="/images/india/Merangar-Pano.jpg" alt="Merangar-Pano"></p><p><strong>The Stones of Mehrangarh</strong></p><p>Where the desert plains soften into a scrubby forest, lies a slumbering giant: the fortress of Mehrangarh. As these walls come into view, which tower 125 metres above the city of Jodhpur, the power of Jaisalmer is quickly forgotten. Rao Jodha founded the city and fortress in 1459. A tale from that time provides an insight into the superstition that ruled kings, and the desperation that dominated the poor. An ascetic who’d previously called the hilltop his home cursed Rao’s Fort to forever lack water. To mitigate the curse, a man was buried alive in the foundations, and in return his family was cared for by the Raj: a delusional deal. This power built in stone was again coveted by the Moghuls, who went to great lengths to maintain their alliance with the rulers of Merangarh, on whom Emperor Shah Jahan first bestowed the title of Maharajah. </p><p>The immensity of Mehrangarh washes over you like a strong breeze, leaving one with a feeling of smallness in the wake of something so large. There is no greater monument to the power of the Rajput kings, now faded from this world. </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Identity is the only form of politics</title>
    <link href="/2015/05/23/identity-politics/"/>
    <url>/2015/05/23/identity-politics/</url>
    
    <content type="html"><![CDATA[<p>Identity is the way we transpose the subjective into the objective. It is the fixed point by which we pivot between our personal universe and the social world. Identity is the only way to politics, though “Identity Politics” has been denounced by many as too post-modern, or a cause of modern political apathy, or a conscious plan by the elite to divide the working class. The denial of identity as fundamental to political or human experience is drawn from the hubris of infallibility.</p><p>Insofar as politics in a cultural and social phenomenon, it is influenced by identity in three ways. First, one’s identity grows concurrently with beliefs and ideology. Second, shared identities are the foundation of political groups. Third, identity drives effective political action from popular opinion to war. These discussions are not so abstract as to be irrelevant to the world today. Conflict in the 21st century cannot be understood without understanding the perceptions and motivations that drive the actions of modern politicians, parties and states. </p><p>The USA and ISIS have this is common: both have unshakeable belief in manifest destiny, and that empowers those that fight in all arenas.</p><p>Power in human societies derives from social relations. The ‘lone wolf’ is impotent. As societies have grown more complex and specialised, so too have groups have become more diverse. Social groups today vary widely - some proselytise, some isolate, some prosper and some are destroyed. To understand the relationship between group membership and identity we can analyse the language used to proclaim membership. Which statement is stronger (I choose Christian here as an example of a successful group) “I am a Christian” or “I have a Christian group membership”? Members of successful social groups internalise the identity of that group. Hence, we are comfortable with people proclaiming “I am a Christian/ liberal/ soldier/ worker”. And now my strong claim: the power of individuals is insignificant compared to the power of groups, and groups are comprised of individuals who have internalised a collective identity.</p><p>Once internalised, group identities are known as ideologies and comprised of beliefs. The psychological mechanism by which group identities are internalised is often called indoctrination, but could as much be called education or socialisation. The keen observer will note that members of groups will often hold vastly different beliefs (Catholics on birth control, for example). Clearly, a person can internalise multiple group identities, and contradictions between them can have painful psychological consequences. I believe this pain is they key driver of divergence of beliefs within a group, as exemplified by isolated groups. In isolated cults, or tribes, or any other group cut off from broader society, members will tend to converge toward common beliefs. However, most of us must navigate the pitfalls of multiple identities, attempting to reconcile internal contradictions. What is it that prevents us from renouncing an identity? Why is it that group identities persist? I propose that the answer lies in the objectivity and universality provided by these group identities. Converts to Islam gain much more than acceptance in Muslim communities. They are gifted with an “objective” truth on which to build their own psychological structures. It seems to me that all humans are resistant to the idea that “everything is subjective”. We prefer to belief that somewhere there exists a strong foundation on which to build our lives. Objectivity is the language of strength and infallibility. Any claim to objectivity is logically isomorphic to a theological axiom. Subjectivity is frightening - it recognises that there are no certainties, and that we are <em>all </em>fallible. Myself, as a subjectivist, claim that there is no functional difference between agreement and fact. Here we come to the crux of the relationship between group identity and ideology: group identities are persistent and can claim objectivity, hence providing psychological comfort for believers. The stronger the objectivity, the more members feel they are working “for something bigger than themselves”, be it God, the Truth, or the Empire, and hence the more likely they are to sacrifice their individual existence to the group.</p><p>Well that’s all very well and good, but what exactly does it have to do with conflict in the modern world? To answer that, we must ask what is it that motivates political action, for political action is inherently entering a conflict. Significant political action is always entered into by groups, though groups will often have a leader, figurehead or otherwise, even the strongest dictator needs allies. The conflict need not be violent, as modern parliaments attest. But to be successful, political action must either promote the spread of an identity, or increase the power of the group (for simplicity, I’ve intentionally ignored subset identities). By reduction, I find that all successful groups attempt the following: retain existing members; create new members; increase the power of members. I shall call this the fundamental heuristic of successful groups. New members, if not born into the group, must necessarily be converts (though as mentioned earlier, they may not renounce their other identities). Conversion is an increase in the power of the new group through the addition of a new member as well as through volume effects, which is often coincident with a decrease in power of other groups. Consistent with the heuristic of successful groups, the other groups will resist the conversion. Readers should find similarity between the description given above and theories of evolution. Groups are analogous to species. Successful species must: stay alive long enough to reproduce (retain existing members); reproduce successfully (create new members); adapt to the environment, avoid predators and evade parasites (increase the power of members).</p><p>All of the mass religions are successful groups, and in particular, I will consider Christianity. Christianity grew from a small choral in 33AD to over a billion today. Following the heuristic of successful groups, I expect that Christianity was particularly good at retaining members, acquiring new members, and increasing the power of members. The first two heuristics are clearly true. Jesus’ disciples did not renounce him after his death, so clearly early Christianity retained its members. Later Christianity, with ideological and religious hegemony, was particularly good at punishing heretics and unbelievers. But why were Christians stoic during the three centuries of Roman persecution? I suspect that the answer lies in the central objectivity and universality of early Christian doctrine, as well as the comfort and precedence it gave to the poor. It is incontestable that Christianity is good at acquiring new members - it has conquered entire continents. The final heuristic is harder to judge: has Christianity increased the power of its members? Not every Christian is powerful, but even if I attempt to consider the average power of Christians over the entire Christian period, I find am unable to disentangle Christian power from non-Christian power. Therefore, I will consider a single point in Christian history, and perhaps the most significant: the conversion of Constantine. I cannot believe that anyone would argue that this was not an increase in the total power of Christianity, as well as an increase for every Christian. While this narrative should corroborate the fundamental heuristic, it should equally apply to many other successful groups. I can, however, think of groups whose strategies for survival include exclusivity, meaning that the number of new members is purposefully limited, in order to increase the power of existing members.</p><p>To summarise: long lived social groups consist of individuals who have internalised a group identity. The beliefs and ideology of the members create objective coordinates with which members can orient themselves. Actions made by these members, and hence by the group, are motivated by those very same beliefs and ideology. The stronger the claim to objectivity, the more members will act in the interest of the group over themselves. Successful groups tend to retain existing members, to create new members, and to increase the power of members - this is called the fundamental heuristic of successful groups.</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>On Free Will</title>
    <link href="/2014/10/23/on-free-will/"/>
    <url>/2014/10/23/on-free-will/</url>
    
    <content type="html"><![CDATA[<p>Choice and free will are convenient conceptual shorthands to express some of the complexity of human existence. But what <em>is </em>freedom? Are all choices free choices, and what are the hidden ideological and cognitive structures that give meaning to those questions? Ultimately, ideas of self are intimately entwined with conceptions of and belief in free will, and we must examine the conceptual, cultural and spiritual roots of self to come to terms with freedom, will and choice. First, I must describe orthodox free will and its origins in western enlightenment philosophy. Then, after critiquing this view, I will offer an alternative, not by directly answering the question, but by a different interpretation of self. My proposition is that to ask whether one has free will, one implicitly legitimises a European-derived conceptualisation of self, which can induce motivation and spiritual pain.</p><br><p>Modern dominant notions of free will (in the west) are derived from individualist philosophies. By this, I mean that choices, which are the building blocks of will, are perceived of as being transactional, occurring between atomic individuals. Rationality is described through ideas like “homo-economicus” and is essentially reductionist. Hence, modern discourse on free will centres around problems of determinism; that is, to what degree are one’s actions pre-determined by the physical world? There are four responses to determinism, and you can read more about them on Wikipedia.</p><p><img src="/images/freewillgrid.png" alt="freewillgrid"></p><p>Modern western societies live with these ideas embedded into their psycho-social frameworks, even though they are discredited by modern mathematics (chaos) and physics (quantum). Westerners tend to think of ourselves as individuals interacting with the world. There is a fundamental dualism between ourselves and the world. Enter choice: the universe exists, and we choose how to act within it. Thus arises a modern spiritual dilemma. If science has explained and hence can predict every action-reaction, then how can our choices be meaningful? To most western egos, it is psychologically unacceptable to give so little weight to one’s own psychological existence. “I <em>feel </em>choice, and it hurts to think I’ve been deluded for my entire life”. So most of us compromise with something like the following: “I don’t know whether free will exists, so I may as well believe it does.”</p></p><p>Western free will is a convenient collective delusion. It is an inevitable response to atomic individualism, by which I mean the idea that I exist entirely and exclusively within my own body. There are at least two methods for refuting atomic individualism, and those are non-western spirituality, and modern physics and mathematics.</p><br><p>At the heart of an atomic individual’s free will is ego. Ego says, “my opinion is important”; “my existence is unique”; “my perspective matters”; and “I am separate”. In Eastern spiritual traditions, like Buddhism, but also in many traditional societies, rejection of ego is valued, particularly in spiritual activities that seek ego death. In these traditions we also find individualism to be much differently perceived. Ubuntu is an African idea, roughly meaning I am because we are. Essentially, individuals are not complete by themselves; they are not atomic. Buddhism walks a middle path. Clearly, one should not deny the physical circumstances that circumscribe possible actions, and hence limit free choice. But there must exist some degree of free will, because to deny it would be to deny the efforts of Buddhists to make moral progress. To ask the question “is there free will” is problematic, because freedom is necessarily constrained by environment, and freedom is a cultural concept dependant on philosophical and social education.</p><br><p>Modern physics and mathematics provide westerners with a path to rejecting atomic individualism and hence the orthodox formulation of the problem of free will. Contrary to Newton and those who followed, the universe is not deterministic. Neither are boundaries well defined. Most mathematical history revolves around simple abstractions. Consider a cube, which is a simple shape with well defined boundaries, finite volume and finite surface area. All points in space can be determined to lie inside or outside the cube. We have known as early as Pythagoras that the real world does not contain cubes - hence the Pythagorean and Platonic obsession with abstraction. A lesser known revolution in the late 20th century dispensed with these shapes in favour of fractal geometries. The universe is much better described using <a title="fractal geometry" href="http://en.wikipedia.org/wiki/Patterns_in_nature#Trees.2C_fractals" target="_blank">fractal geometry</a>. Unlike cubes, fractals do not have well defined boundaries. Fractals are often formed by the process of recursion. In an interpretation of self by mathematician Douglas Hofstadter in <em>I am a Strange Loop, </em>consciousness and the self can be thought of as an emergent phenomenon from self referential feedback. If we accept this interpretation, then we can expect the “shape” of our consciousness to be a fractal, and hence not to have well defined boundaries. In itself, this strikes a fatal blow to atomic individualism. Chaos theory also strikes a blow to determinism, and quantum mechanics rings a death knell. I leave it to the reader to explore the revelations of modern scholarship.</p><br><blockquote><p>Chaos: When the present determines the future, but the approximate present does not approximately determine the future.  -  Edward Lorenz</p></blockquote><br><p>Now, where do we find ourselves? Adrift in a chaotic universe, without even our selves as rocks in a turbulent ocean. And where is free will? I propose there is no free will, there is only will. We are not free, we are constrained by our physical and our social world. But there is spirituality that provides consolation. We are not atomised individuals. The boundary between us is fractal - it is impossible to tell precisely where you end and I begin. The same is true for our selves and the physical universe. This revelation provides concrete reasons to believe in the interconnectedness of all people, all life, all places, and all times. I am not separate from the world, but a part of it; and what is my puny will to the will of the universe. And yet the universe is not cold, because you exist, and us manifests. To revel in the soup of souls, one must leave free will behind, and recognise that whatever we are, we are it together.</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>The Battle for Eurasia</title>
    <link href="/2014/05/23/the-battle-for-eurasia/"/>
    <url>/2014/05/23/the-battle-for-eurasia/</url>
    
    <content type="html"><![CDATA[<p>The pieces are moving; the battle for Eurasia has begun.</p><p>The 20th century saw the the first global wars. Before the onset of the great war, European powers dominated the globe through superior technology, particularly in war. Two world wars later, and the balance of power had shifted dramatically.</p><p>Orthodox interpretation of the post war period proposes a war of ideologies between capitalism and collectivism. But this was essentially a collective brainwashing by the two major powers of the era: the Soviet Union and the United States. In the west, the narrative goes something like: <em>capitalism and democracy are fundamentally connected, and are better than communism</em>. However, this interpretation entirely fails to account for the role of China in the fall of the USSR.<br>In 1971 Kissinger traveled to China, initiating a secret strategic relationship between the emerging Chinese Communist-led state and the Americans. In Chinese terms, using the far away enemy against the near enemy. The Sino-Soviet split became a dagger to the heart of soviet communism. The Soviet Union, which became heavily militarised and surrounded by enemies, could not sustain both its economy and military in such a hostile environment. What followed was victory for the Americans and the Chinese. Once again, orthodox interpretation of the fall resembles Fukuyama. But events in the early 21st century throw new challenges to the end of history. History, rather than ending, provides new challenges.</p><p>Today, an assertive China is evolving into a modern superpower, and a newly resurgent Russia refuses to be relegated to middle-power status. A multi-polar world order is emerging, old alliances are shifting, middle powers are trapped between feuds, and smaller countries are destroyed. The great game is being played once again.</p><p>At the heart of the new great game is a challenge to a global hegemony of the United States. US power is being challenged in two great theatres: East Asia and the Mediterranean. In the Mediterranean, states and leaders are falling like flies. Almost every country bordering the sea has been touched by the shifting world order, from Spain, Italy and Greece’s battle with the European troika, to the stalled revolution in Egypt, to the war for the heart of the middle east in Syria and Iraq. The victorious powers of the 20th century can still flex significant military might, as they demonstrated in the removal of Gaddafi. But the will of NATO is not so strong as it was. Its power is being challenged in Ukraine and in Syria, by a newly confident Russia, and quietly backed by a diplomatic China. However, the battles are not just military. In a ominous reflection of the complex web of agreements between states before the outbreak of war in 1914, great and middle powers are scrambling to sign multi-billion dollar deals to draw others into their spheres of influence. In 2014, Russia signed significant gas, nuclear and weapons deals that span decades, and they signed them with partners of great strategic importance. Similarly, China has created new institutions for infrastructure in South East Asia. Considering these deals gives us some insight into the state of the great game at the end of this year.</p><p>Since 1991, Sino-Russian relations have improved dramatically from the lows of the 20th century. Old territorial disputes have been solved, and cross border trade increased. In 2014, the two signed a 30 year long gas contract (Russia supplying 38 billion cubic litres per year) as well as a 150 billion yuan central bank liquidity swap. It is this relationship that will come to define geopolitics in Eurasia, because it allows both Russia and China to focus their efforts in regions of much greater value than the long desolate border between them. For China, a secure Russian border allows it to focus its power (especially military power) in the east, around disputed territories and valuable natural resources. Russia, who has always struggled with distance fronts and long supply lines, can focus of conflicts in the West, including in the Middle East and western Europe. An economic game is also afoot. This week Russia signed a hundred billion dollar deal with India, just weeks after cancelation of the South Stream gas pipeline project, which now terminates in Turkey. Turkey too has been signing billion dollar deals with the bear from the north. A line has been drawn, across which Russia will not tolerate NATO forces, and within which countries lie inside its sphere of influence. It runs south from Belarus, bisecting the Ukraine, Crimea and the Black Sea, to Turkey, Syria and Iraq and ending somewhere in the gulf. Hence, Russia and NATO find themselves at odds over the future of Syria. Not only because of relatively recent militarism in nearby Georgia, but because of a greater struggle between the USA and EU (NATO) and Russia and China, what one could refer to as the Shanghai Cooperation Organisation.</p><p>The game is being played by countries as far away as Australia. Ukrainian president Petro Poroshenko visited last week, in an event that likely benefited both himself and Australian Prime Minister Tony Abbott. For Poroshenko, the visit lends legitimacy. For Abbott, the visit reminds the Australian public of the downing of MH17, a strong point of Abbott, who has become desperately unpopular in recent months. The two signed a trade deal worth perhaps one hundred million dollars - puny in comparison with deals discussed above, but significant for its symbolic value.</p><p>Is Eurasia heading for war once again? Or has the nature of great power changes dramatically from 100 years ago? Enter 2015.</p><p><img src="https://upload.wikimedia.org/wikipedia/commons/3/30/Eurasia_%28orthographic_projection%29.svg" alt="Eurasia highlighted on a globe"></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
